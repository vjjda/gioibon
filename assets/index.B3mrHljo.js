import{i as L,u as k,w as T}from"./vendor-sqlite.B5d0IBhS.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();const O={},E=O?"/gioibon/":"/",y={API_KEY:"google_cloud_api_key",TTS_VOICE:"tts_voice_name",TTS_RATE:"tts_rate",TTS_CACHE_LIST:"tts_gcloud_voices_list",TTS_CACHE_TS:"tts_gcloud_voices_ts"},v={VOICE_LANG:"vi-VN",VOICE_NAME:"vi-VN-Chirp3-HD-Charon",RATE:1.5,CACHE_DURATION:10080*60*1e3},P={TTS:"https://texttospeech.googleapis.com/v1/text:synthesize",VOICES:"https://texttospeech.googleapis.com/v1/voices"},I={SCROLL_THRESHOLD_TOP:80,SCROLL_THRESHOLD_BOTTOM:80,SCROLL_BEHAVIOR:"smooth"},C="libs/wa-sqlite/wa-sqlite-async.wasm";class M{constructor(e="content.db",t=`${E}app-content/content.db`){this.dbName=e,this.dbUrl=t,this.db=null}async init(){if(this.db)return this.db;try{const e=this.dbUrl.replace(/\.db$/,"_version.json"),t=`db_version_${this.dbName}`,i=localStorage.getItem(t);let s=!1,n=null;const a=new AbortController,o=setTimeout(()=>a.abort(),1500);try{const r=await fetch(`${e}?t=${Date.now()}`,{cache:"no-store",signal:a.signal});clearTimeout(o),r.ok?(n=await r.json(),n.version!==i?(console.log(`‚ôªÔ∏è DB updated. Old: ${i}, New: ${n.version}`),s=!0):console.log("‚úÖ DB is up-to-date. Using local cache.")):(console.warn(`‚ö†Ô∏è Cannot fetch version file (${r.status}). Force checking integrity.`),s=!i)}catch{clearTimeout(o),console.warn("‚ö†Ô∏è M·∫°ng kh√¥ng ·ªïn ƒë·ªãnh ho·∫∑c Offline. Chuy·ªÉn sang d√πng Local DB ngay l·∫≠p t·ª©c."),s=!i}if(s){console.log("‚¨áÔ∏è Downloading fresh DB...");const r=await fetch(`${this.dbUrl}?t=${Date.now()}`,{cache:"no-store"});if(!r.ok)throw new Error(`Failed to download DB: ${r.status}`);const l=await r.arrayBuffer(),c=new File([l],this.dbName),h=await L(k(this.dbName,{...T(c),url:C}));n&&localStorage.setItem(t,n.version),this.db=h;try{await h.run("PRAGMA cache_size = 500"),await h.run("PRAGMA temp_store = MEMORY"),await h.run("PRAGMA synchronous = OFF"),await h.run("PRAGMA mmap_size = 0"),await h.run("PRAGMA query_only = 1")}catch(u){console.warn("‚ö†Ô∏è Cannot set PRAGMAs",u)}}else{const r=await L(k(this.dbName,{url:C}));try{if((await r.run("SELECT name FROM sqlite_master WHERE type='table' AND name='contents'")).length===0)return console.warn("‚ùå Cached DB is empty/corrupted. Force re-downloading."),localStorage.removeItem(t),this.db=null,await this.forceDownload();await r.run("PRAGMA cache_size = 500"),await r.run("PRAGMA temp_store = MEMORY"),await r.run("PRAGMA mmap_size = 0"),await r.run("PRAGMA query_only = 1")}catch(l){return console.warn("‚ùå DB integrity check failed.",l),localStorage.removeItem(t),this.db=null,await this.forceDownload()}this.db=r}return this.db}catch(e){throw console.error("‚ùå SqliteConnection Init Error:",e),e}}async forceDownload(){console.log("üîÑ Force downloading DB...");const e=await fetch(`${this.dbUrl}?t=${Date.now()}`,{cache:"no-store"});if(!e.ok)throw new Error(`Failed to download DB: ${e.status}`);const t=await e.arrayBuffer(),i=new File([t],this.dbName);this.db=await L(k(this.dbName,{...T(i),url:C}));try{const s=this.dbUrl.replace(/\.db$/,"_version.json"),n=await fetch(`${s}?t=${Date.now()}`,{cache:"no-store"});if(n.ok){const a=await n.json();localStorage.setItem(`db_version_${this.dbName}`,a.version)}}catch{}try{await this.db.run("PRAGMA cache_size = 500"),await this.db.run("PRAGMA temp_store = MEMORY"),await this.db.run("PRAGMA mmap_size = 0"),await this.db.run("PRAGMA query_only = 1")}catch{}return this.db}async query(e,t=[]){return this.db||await this.init(),await this.db.run(e,t)}}class H{constructor(){this.apiKey=localStorage.getItem(y.API_KEY)||"",this.cachedVoices=this._loadVoicesFromCache(),this.voice={languageCode:v.VOICE_LANG,name:localStorage.getItem(y.TTS_VOICE)||v.VOICE_NAME},this.rate=parseFloat(localStorage.getItem(y.TTS_RATE))||v.RATE}setApiKey(e){this.apiKey=e,localStorage.setItem(y.API_KEY,e)}getApiKey(){return this.apiKey}hasApiKey(){return!!this.apiKey&&this.apiKey.length>0}setVoice(e,t="vi-VN"){this.voice={name:e,languageCode:t},localStorage.setItem(y.TTS_VOICE,e)}setRate(e){this.rate=e,localStorage.setItem(y.TTS_RATE,e)}_loadVoicesFromCache(){const e=localStorage.getItem(y.TTS_CACHE_LIST);if(e)try{return JSON.parse(e)}catch(t){console.warn("Failed to parse cached voices:",t)}return[]}async getVoices(e=!1){if(!this.apiKey)return[];const t=parseInt(localStorage.getItem(y.TTS_CACHE_TS)||"0"),i=Date.now();if(!e&&this.cachedVoices.length>0&&i-t<v.CACHE_DURATION)return console.log("Using cached voices."),this.cachedVoices;console.log("Fetching voices from API...");try{const s=await fetch(`${P.VOICES}?key=${this.apiKey}&languageCode=vi-VN`);if(!s.ok)return this.cachedVoices.length>0?(console.warn("Fetch failed, using stale cache."),this.cachedVoices):[];const o=((await s.json()).voices||[]).filter(r=>r.languageCodes.includes("vi-VN"));return o.length>0&&(this.cachedVoices=o,localStorage.setItem(y.TTS_CACHE_LIST,JSON.stringify(o)),localStorage.setItem(y.TTS_CACHE_TS,i.toString())),o}catch(s){return console.error("Error fetching voices:",s),this.cachedVoices.length>0?this.cachedVoices:[]}}async fetchAudioBlob(e){if(!this.apiKey)throw new Error("Vui l√≤ng nh·∫≠p Google Cloud API Key trong ph·∫ßn C√†i ƒë·∫∑t.");const t={input:{text:e},voice:{languageCode:this.voice.languageCode,name:this.voice.name},audioConfig:{audioEncoding:"MP3",speakingRate:this.rate,pitch:0}};try{const i=await fetch(`${P.TTS}?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!i.ok){const n=await i.json().catch(()=>({}));throw new Error(n.error?.message||`API Error: ${i.status}`)}const s=await i.json();if(s.audioContent){const n=atob(s.audioContent),a=new Uint8Array(n.length);for(let o=0;o<n.length;o++)a[o]=n.charCodeAt(o);return new Blob([a],{type:"audio/mp3"})}throw new Error("No audio content received")}catch(i){throw console.error("TTS Fetch Error:",i),i}}async fetchAudio(e){const t=await this.fetchAudioBlob(e);return new Promise((i,s)=>{const n=new FileReader;n.onloadend=()=>i(n.result),n.onerror=s,n.readAsDataURL(t)})}}class q{constructor(){this.ttsRules=null,this.rulesPromise=this._loadRules()}async _loadRules(){try{const e=await fetch(`${E}app-content/tts_rules.json`);e.ok&&(this.ttsRules=await e.json())}catch(e){console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y tts_rules.json",e)}}async normalize(e){if(!e)return"";if(await this.rulesPromise,!this.ttsRules)return e;let t=e;if(this.ttsRules.remove_html&&(t=t.replace(/<[^>]*>?/gm,"")),this.ttsRules.remove_chars){const i=this.ttsRules.remove_chars.map(n=>this._escapeRegExp(n)).join(""),s=new RegExp(`[${i}]`,"g");t=t.replace(s," ")}if(this.ttsRules.collapse_spaces&&(t=t.replace(/\s+/g," ").trim()),this.ttsRules.phonetics)for(const[i,s]of Object.entries(this.ttsRules.phonetics)){const n=new RegExp(this._escapeRegExp(i),"gi");t=t.replace(n,s)}return this.ttsRules.capitalize_upper&&this._isUpper(t)&&(t=this._capitalize(t)),t}_escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}_isUpper(e){return e===e.toUpperCase()&&e!==e.toLowerCase()}_capitalize(e){return e&&e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()}}const D="tts_audio_cache",b="audios",U=1;class V{constructor(){this.db=null,this.initPromise=this.init()}async init(){if(!this.db)return new Promise((e,t)=>{const i=indexedDB.open(D,U);i.onupgradeneeded=s=>{const n=s.target.result;n.objectStoreNames.contains(b)||n.createObjectStore(b,{keyPath:"hash"})},i.onsuccess=s=>{this.db=s.target.result,e()},i.onerror=s=>{console.error("AudioCache IDB Error:",s.target.error),t(s.target.error)}})}async generateHash(e,t,i){if(!e)return null;const s=`${e}|${t}|${i}`,a=new TextEncoder().encode(s),o=await crypto.subtle.digest("SHA-256",a);return Array.from(new Uint8Array(o)).map(c=>c.toString(16).padStart(2,"0")).join("").substring(0,16)}async get(e){return await this.initPromise,new Promise((t,i)=>{const a=this.db.transaction([b],"readonly").objectStore(b).get(e);a.onsuccess=()=>{t(a.result?a.result.blob:null)},a.onerror=()=>i(a.error)})}async set(e,t){return await this.initPromise,new Promise((i,s)=>{const a=this.db.transaction([b],"readwrite").objectStore(b),o={hash:e,blob:t,timestamp:Date.now()},r=a.put(o);r.onsuccess=()=>i(),r.onerror=()=>s(r.error)})}async has(e){return!!await this.get(e)}}const _=new V;class ${constructor(e,t){this.engine=e,this.dbConnection=t}async resolve(e,t,i,s){const n=await s.normalize(e.text);if(t!==i()||!n)return null;const a=this.engine.voice.name,o=this.engine.voice.languageCode,r=await _.generateHash(n,a,o);if(e.audio&&e.audio!=="skip")return{url:`${E}app-content/audio/${e.audio}`,isBlob:!1};if(await _.has(r)){if(t!==i())return null;const l=await _.get(r);return{url:URL.createObjectURL(l),isBlob:!0}}if(this.engine.hasApiKey())try{const l=await this.engine.fetchAudioBlob(n);return t!==i()?null:(await _.set(r,l),{url:URL.createObjectURL(l),isBlob:!0})}catch(l){console.error("AudioResolver API Error:",l)}return null}}class F{constructor(e){this.engine=new H,this.textProcessor=new q,this.audioResolver=new $(this.engine,e),this.audioElement=new Audio,this.audioQueue=[],this.isPlaying=!1,this.isPaused=!1,this.currentAudio=this.audioElement,this.currentSegmentId=null,this.isSequence=!1,this.sequenceParentId=null,this.isLooping=!1,this.currentPlaylist=[],this.onSegmentStart=null,this.onSegmentEnd=null,this.onPlaybackEnd=null,this.onPlaybackStateChange=null,this.playbackSessionId=0,this.preloadMap=new Map,this.preloadDepth=2,this.currentBlobUrl=null}setApiKey(e){this.engine.setApiKey(e)}getApiKey(){return this.engine.getApiKey()}setVoice(e){this.engine.setVoice(e)}setRate(e){this.engine.setRate(e)}getVoices(e){return this.engine.getVoices(e)}get currentVoice(){return this.engine.voice}get currentRate(){return this.engine.rate}playSegment(e,t,i){if(String(this.currentSegmentId)===String(e)&&(this.isPlaying||this.isPaused)){this.togglePause();return}this._startNewSession(),this.isPaused=!1,this.isSequence=!1;const s={id:e,audio:t,text:i};this.audioQueue=[s],this.currentPlaylist=[s],this._processQueue()}playSequence(e,t=null){if(this.isSequence&&e.length>0&&this.currentPlaylist.length>0&&String(this.currentPlaylist[0].id)===String(e[0].id)&&(this.isPlaying||this.isPaused)){this.togglePause();return}this._startNewSession(),this.isPaused=!1,this.isSequence=!0,this.sequenceParentId=t,this.audioQueue=[...e],this.currentPlaylist=[...e],this._processQueue()}pause(){this.audioElement.paused||(this.audioElement.pause(),this.isPaused=!0,this.isPlaying=!1,this._emitState("paused"))}resume(){this.audioElement.paused&&this.isPaused?(this.audioElement.play(),this.isPaused=!1,this.isPlaying=!0,this._emitState("playing")):this.audioQueue.length>0&&!this.isPlaying&&!this.isPaused&&this._processQueue()}togglePause(){this.isPaused?this.resume():this.pause()}stop(){this._cleanupSession(),this.audioQueue=[],this.currentPlaylist=[],this.sequenceParentId=null,this.audioElement.pause(),this.audioElement.currentTime=0,this.audioElement.removeAttribute("src"),this.audioElement.load(),this._revokeCurrentBlob(),this.isPlaying=!1,this.isPaused=!1,this.currentSegmentId=null,this.isSequence=!1,this.onPlaybackEnd&&this.onPlaybackEnd(),this._emitState("stopped")}_startNewSession(){this._cleanupSession(),this.playbackSessionId++}_cleanupSession(){for(const e of this.preloadMap.values())URL.revokeObjectURL(e);this.preloadMap.clear()}_revokeCurrentBlob(){this.currentBlobUrl&&(URL.revokeObjectURL(this.currentBlobUrl),this.currentBlobUrl=null)}_getCurrentSessionId(){return this.playbackSessionId}async _preloadNextItem(){if(this.audioQueue.length===0)return;const e=this.playbackSessionId;for(let t=0;t<Math.min(this.preloadDepth,this.audioQueue.length);t++){const i=this.audioQueue[t];if(!this.preloadMap.has(i.id)){const s=await this.audioResolver.resolve(i,e,()=>this.playbackSessionId,this.textProcessor);s&&s.isBlob&&this.playbackSessionId===e&&this.preloadMap.set(i.id,s.url)}}}async _processQueue(){if(this.audioQueue.length===0)if(this.isLooping&&this.currentPlaylist.length>0)this.audioQueue=[...this.currentPlaylist];else{this.stop();return}if(this.isPaused)return;this._revokeCurrentBlob(),this.isPlaying=!0,this._emitState("playing");const e=this.audioQueue.shift();this.currentSegmentId=e.id,this.onSegmentStart&&this.onSegmentStart(e.id,this.isSequence);try{const t=this.playbackSessionId;let i=null,s=!1;if(this.preloadMap.has(e.id))i=this.preloadMap.get(e.id),s=!0,this.preloadMap.delete(e.id);else{const a=await this.audioResolver.resolve(e,t,()=>this.playbackSessionId,this.textProcessor);a&&(i=a.url,s=a.isBlob)}if(t!==this.playbackSessionId)return;if(!i){this._handleSegmentEnd(e.id,null);return}s&&(this.currentBlobUrl=i),this.audioElement.src=i,this.engine.rate&&(this.audioElement.playbackRate=this.engine.rate);const n=()=>{this._revokeCurrentBlob(),this._handleSegmentEnd(e.id)};this.audioElement.onended=n,this.audioElement.onerror=a=>{console.error("Audio Playback Error:",a,i),n()},await this.audioElement.play(),this._preloadNextItem()}catch(t){console.error("Playback error",t),this._handleSegmentEnd(e.id)}}_handleSegmentEnd(e){this.onSegmentEnd&&this.onSegmentEnd(e),this._processQueue()}_emitState(e){this.onPlaybackStateChange&&this.onPlaybackStateChange(e)}}class K{constructor(e){this.db=e||new M,this.data=null}async load(){if(this.data)return this.data;try{this.data=[];let t=0,i=!0;for(;i;){const s=await this.db.query(`SELECT uid, html, label, audio_name, 
                     CASE WHEN hint IS NOT NULL AND hint != '' THEN hint ELSE segment END as text 
                     FROM contents WHERE uid > ${t} ORDER BY uid ASC LIMIT 100`);if(s&&s.length>0){const n=s.map(a=>({id:a.uid,html:a.html,label:a.label,audio:a.audio_name,text:a.text}));this.data.push(...n),t=s[s.length-1].uid,await new Promise(a=>setTimeout(a,5))}else i=!1}return this.data}catch(e){throw console.error("ContentLoader Error:",e),e}}getAllSegments(){return this.data?this.data.filter(e=>e.audio!=="skip").map(e=>({id:e.id,audio:e.audio,text:e.text})):[]}getSegmentsStartingFrom(e){if(!this.data)return[];let t=0;return e&&(t=this.data.findIndex(s=>s.id===e),t===-1&&(t=0)),this.data.slice(t).filter(s=>s.audio!=="skip").map(s=>({id:s.id,audio:s.audio,text:s.text}))}getSegment(e){return this.data?.find(t=>t.id===e)}getSegmentsByLabelPrefix(e){return this.data?this.data.filter(t=>t.label.startsWith(e)):[]}getRuleSegments(e,t){return[]}}class W{constructor(e,t,i,s){this.container=document.getElementById(e),this.sidebar=document.getElementById(t),this.toggle=document.getElementById(i),this.contentRenderer=s,this.activeLink=null}render(e){if(!this.container)return;this.container.innerHTML="";const t=document.createElement("ul");t.className="toc-main-list",this.container.appendChild(t);let i=null,s=null,n=null;e.forEach(a=>{const o=a.html?a.html.match(/^<h(\d)>(.*?)<\/h\d>/i):null,r=a.label.endsWith("-name");if(o||r){let l=o?parseInt(o[1]):4;r&&(l=4);let c=(a.text||"").replace(/<[^>]*>?/gm,"").trim();if(!c&&!r)return;const h=this._createLink(a,c,l);if(l===1){const u=document.createElement("li");u.className="toc-item level-title",u.appendChild(h),t.appendChild(u),i=null,s=null,n=null}else if(l===2){const u=document.createElement("li");u.className="toc-item level-h2",u.appendChild(h),t.appendChild(u),i=u,s=null,n=null}else if(l===3){const u=document.createElement("li");u.className="toc-item level-h3",u.appendChild(h),t.appendChild(u),s=u,n=null}else if(l===4){const u=s||i;if(u){(!n||n.parentElement!==u)&&(n=document.createElement("ul"),n.className="toc-rule-list",u.appendChild(n));let m=c;const g=c.match(/^(\d+)\./)||c.match(/^(\d+)$/)||c.match(/(\d+)$/);if(g)m=g[1];else{const f=a.label.match(/([a-z]+)(\d+)-name/i);f&&(m=f[2])}m.length>3&&(m=m.substring(0,3)),h.textContent=m,h.title=c,h.className="toc-link rule-link";const p=document.createElement("li");p.className="toc-rule-item",p.appendChild(h),n.appendChild(p)}}}}),this._setupToggle()}_createLink(e,t,i){const s=document.createElement("a");return s.className="toc-link",s.href=`#segment-${e.id}`,s.dataset.id=e.id,s.textContent=t,s.onclick=n=>{n.preventDefault(),this._handleLinkClick(e.id,s)},s}_handleLinkClick(e,t){this.contentRenderer&&this.contentRenderer.scrollToSegment(e),this._setActive(t),window.innerWidth<=1024&&this.sidebar&&this.sidebar.classList.remove("visible")}_setActive(e){this.container&&this.container.querySelectorAll(".toc-link").forEach(t=>t.classList.remove("active")),e.classList.add("active"),this.activeLink=e}_setupToggle(){if(!this.toggle)return;const e=this.toggle.cloneNode(!0);this.toggle.parentNode.replaceChild(e,this.toggle),this.toggle=e,this.toggle.addEventListener("click",t=>{if(t&&t.stopPropagation(),window.innerWidth>1024){this.sidebar.classList.toggle("collapsed");const i=document.querySelector(".container");i&&i.classList.toggle("sidebar-collapsed")}else this.sidebar.classList.toggle("visible")}),document.addEventListener("click",t=>{window.innerWidth<=1024&&this.sidebar&&!this.sidebar.contains(t.target)&&!this.toggle.contains(t.target)&&this.sidebar.classList.contains("visible")&&this.sidebar.classList.remove("visible")})}}class G{constructor(e){this.callbacks=e}create(e,t){const i=document.createElement("div");i.className="segment",i.dataset.id=e.id,i.dataset.label=e.label,i.dataset.index=t,i.addEventListener("mouseenter",()=>{this.callbacks.onHover&&this.callbacks.onHover(e.id)}),this._applyClasses(i,e);const s=document.createElement("div");return s.className="segment-content-wrapper",this._addPlayButtons(s,e,t),this._addTextContent(s,e),i.appendChild(s),this._addMaskToggle(i,e),i}_applyClasses(e,t){t.label.endsWith("-name")?e.classList.add("rule-header"):t.label.endsWith("-chapter")?e.classList.add("chapter-header"):t.label==="title"&&e.classList.add("main-title"),t.html&&t.html.match(/^<h[1-6]/i)&&e.classList.add("heading-segment"),t.html&&t.html.match(/class=['"](endsection|endvagga|endsutta|sadhu|namo)['"]/)&&e.classList.add("end-segment")}_addPlayButtons(e,t,i){if(t.audio&&t.audio!=="skip"){const s=document.createElement("button");s.id=`play-btn-${t.id}`,s.name=`play-btn-${t.id}`,s.className="play-btn icon-btn",s.innerHTML='<i class="fas fa-circle"></i>',s.title="Nghe ƒëo·∫°n n√†y",s.onclick=n=>{n.stopPropagation(),this.callbacks.playSegment&&this.callbacks.playSegment(t.id,t.audio,t.text)},e.appendChild(s)}if(t.html&&t.html.match(/^<h[1-6]/i)&&t.label!=="title"&&t.label!=="subtitle"){const s=document.createElement("button");s.id=`play-seq-btn-${t.id}`,s.name=`play-seq-btn-${t.id}`,s.className="play-btn icon-btn play-sequence-btn",s.innerHTML='<i class="fas fa-play-circle"></i>',s.title="Nghe to√†n b·ªô ph·∫ßn n√†y",s.onclick=n=>{n.stopPropagation(),this.callbacks.playSequence&&this.callbacks.playSequence(i)},e.appendChild(s)}}_addTextContent(e,t){const i=document.createElement("div");i.className="segment-text";const n=(t.html||"{}").replace("{}",t.text||"");i.innerHTML=n,e.appendChild(i)}_addMaskToggle(e,t){const i=t.html&&t.html.match(/^<h[1-6]/i)&&t.label!=="title"&&t.label!=="subtitle";if(t.audio&&t.audio!=="skip"||i){const n=document.createElement("div");n.className="segment-mask-toggle",n.title="Nh·∫•p ƒë·ªÉ che/hi·ªán text",this.callbacks.onMaskStart&&(n.addEventListener("mousedown",a=>this.callbacks.onMaskStart(a,e,t)),n.addEventListener("touchstart",a=>this.callbacks.onMaskStart(a,e,t),{passive:!1})),this.callbacks.onMaskEnter&&n.addEventListener("mouseenter",a=>this.callbacks.onMaskEnter(a,e)),e.appendChild(n)}}}class j{constructor(e){this.container=e,this.items=[],this.isDraggingMask=!1,this.dragMaskAction=null,this.lastActionTime=0,this.cooldownMs=250,this._setupGlobalListeners()}setItems(e){this.items=e}_setupGlobalListeners(){const e=()=>{this.isDraggingMask=!1,this.dragMaskAction=null};document.addEventListener("mouseup",e),document.addEventListener("touchend",e)}_isHeading(e){return e.html&&e.html.match(/^<h[1-6]/i)&&e.label!=="title"&&e.label!=="subtitle"}toggleMask(e,t){const i=Date.now();if(i-this.lastActionTime<this.cooldownMs)return;this.lastActionTime=i;const s=e.querySelector(".segment-text");if(!s)return;if(this._isHeading(t)){this._toggleHeadingMask(e,t);return}const n=s.classList.contains("masked");this._applyMaskAction(s,n?"unmask":"mask")}handleMaskStart(e,t,i){if(e.type==="mousedown"&&e.button!==0)return;const s=Date.now();if(s-this.lastActionTime<this.cooldownMs){e&&e.cancelable&&e.preventDefault();return}this.lastActionTime=s,e&&e.cancelable&&e.preventDefault(),this.isDraggingMask=!0;const n=t.querySelector(".segment-text");if(this._isHeading(i)){this._toggleHeadingMask(t,i);return}const a=n.classList.contains("masked");this.dragMaskAction=a?"unmask":"mask",this._applyMaskAction(n,this.dragMaskAction)}handleMaskEnter(e,t){if(!this.isDraggingMask||!this.dragMaskAction)return;const i=t.dataset.id,s=this.items.find(a=>String(a.id)===String(i));if(s&&this._isHeading(s))return;const n=t.querySelector(".segment-text");this._applyMaskAction(n,this.dragMaskAction)}_applyMaskAction(e,t){t==="mask"?e.classList.add("masked"):e.classList.remove("masked")}_toggleHeadingMask(e,t){const i=parseInt(e.dataset.index),s=t.html.match(/^<h(\d)>/i);if(!s)return;const n=parseInt(s[1]);let a="mask";for(let o=i+1;o<this.items.length;o++){const r=this.items[o];if(r.label==="end")break;const l=r.html?r.html.match(/^<h(\d)>/i):null;if(l){if(parseInt(l[1])<=n)break;continue}const c=this._findElement(r.id);if(c){const h=c.querySelector(".segment-text");if(h){a=h.classList.contains("masked")?"unmask":"mask";break}}}for(let o=i+1;o<this.items.length;o++){const r=this.items[o];if(r.label==="end")break;const l=r.html?r.html.match(/^<h(\d)>/i):null;if(l){if(parseInt(l[1])<=n)break;continue}const c=this._findElement(r.id);if(c){const h=c.querySelector(".segment-text");h&&this._applyMaskAction(h,a)}}}_findElement(e){return this.container.querySelector(`.segment[data-id="${e}"]`)}}class z{constructor(e,t,i,s){this.container=e,this.elementCache=t,this.getItems=i,this.ensureRendered=s,this.activeSegmentId=null}scrollToSegment(e){this.highlightSegment(e,!0,"top")}highlightSegment(e,t=!0,i="smart"){if(!this.container)return;let s=this.elementCache.get(e);if(!s){const a=this.getItems().findIndex(o=>o.id===e);a!==-1&&(this.ensureRendered(a),s=this.elementCache.get(e))}if(this.activeSegmentId!==null&&this.activeSegmentId!==e){const n=this.elementCache.get(this.activeSegmentId);n&&n.classList.remove("active")}s&&(s.classList.add("active"),this.activeSegmentId=e,t&&(i==="top"?this._scrollToTop(s):this._smartScroll(s)))}clearHighlight(){if(this.activeSegmentId!==null){const e=this.elementCache.get(this.activeSegmentId);e&&e.classList.remove("active"),this.activeSegmentId=null}}_scrollToTop(e){if(!this.container||!e)return;const t=e.getBoundingClientRect(),i=this.container.getBoundingClientRect(),n=this.container.scrollTop+(t.top-i.top)-20;this.container.scrollTo({top:n,behavior:"auto"})}_parseThreshold(e){return typeof e=="number"?e:typeof e!="string"?0:e.endsWith("vh")?parseFloat(e)/100*document.documentElement.clientHeight:parseFloat(e)||0}_smartScroll(e){if(!this.container||!e)return;const t=e.getBoundingClientRect(),i=this.container.getBoundingClientRect(),s=this._parseThreshold(I.SCROLL_THRESHOLD_TOP),n=this._parseThreshold(I.SCROLL_THRESHOLD_BOTTOM),a=i.top+s,o=i.bottom-n,r=t.top<a,l=t.bottom>o;if(r||l){const h=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)?"auto":I.SCROLL_BEHAVIOR,u=this.container.scrollTop+(t.top-a);this.container.scrollTo({top:u,behavior:h})}}}class Y{constructor(e,t,i,s,n,a){this.getHoveredId=e,this.getItems=t,this.getElementCache=i,this.maskManager=s,this.playSegment=n,this.playSequence=a,this._setupKeyboardListeners()}_setupKeyboardListeners(){document.addEventListener("keydown",e=>{if(e.target.tagName==="INPUT"||e.target.tagName==="SELECT")return;const t=e.key.toLowerCase();t==="r"?this._handleKeyboardPlay():t==="f"&&this._handleKeyboardFlip()})}_handleKeyboardPlay(){const e=this.getHoveredId();if(!e)return;const t=this.getItems(),i=t.find(s=>s.id===e);if(i)if(i.html&&i.html.match(/^<h[1-6]/i)){const s=t.indexOf(i);this.playSequence(s)}else i.audio&&i.audio!=="skip"&&this.playSegment&&this.playSegment(i.id,i.audio,i.text)}_handleKeyboardFlip(){const e=this.getHoveredId();if(!e)return;const i=this.getItems().find(a=>a.id===e);if(!i)return;const n=this.getElementCache().get(e);if(n){const a=i.audio&&i.audio!=="skip",o=i.html&&i.html.match(/^<h[1-6]/i)&&i.label!=="title"&&i.label!=="subtitle";(a||o)&&this.maskManager.toggleMask(n,i)}}}const Q=30;class Z{constructor(e,t,i){this.container=e,this.elementCache=t,this.segmentFactory=i,this.items=[],this.renderedCount=0,this.observer=null,this.sentinel=null,this.currentPrefix=null,this.isRendering=!1}render(e){if(this.container){if(this._cleanup(),this.items=e||[],this.items.length===0){this.container.innerHTML='<div class="empty">Kh√¥ng c√≥ d·ªØ li·ªáu hi·ªÉn th·ªã.</div>';return}this.sentinel=document.createElement("div"),this.sentinel.className="loading-sentinel",this.sentinel.style.height="100px",this.sentinel.style.width="100%",this.container.appendChild(this.sentinel),this.observer=new IntersectionObserver(t=>{t[0].isIntersecting&&!this.isRendering&&(this.isRendering=!0,requestAnimationFrame(()=>this.renderNextBatch()))},{root:this.container,rootMargin:"1000px",threshold:.01}),this.observer.observe(this.sentinel),this.renderNextBatch()}}renderNextBatch(){if(this.renderedCount>=this.items.length){this._removeSentinel();return}const e=this.items.slice(this.renderedCount,this.renderedCount+Q),t=document.createDocumentFragment();let i=this._getCurrentSection();e.forEach((s,n)=>{const a=this.renderedCount+n,o=this._getSectionPrefix(s);(o!==this.currentPrefix||s.label.endsWith("-chapter")||s.label==="title"||!i)&&(this.currentPrefix=o,i=document.createElement("section"),i.className=`section section-${o}`,i.id=`section-${s.label}`,t.appendChild(i));const l=this.segmentFactory.create(s,a);this.elementCache.set(s.id,l),i.appendChild(l)}),this._appendFragment(t),this.renderedCount+=e.length,this.isRendering=!1,this.renderedCount<this.items.length?this.sentinel.getBoundingClientRect().top<window.innerHeight+1e3&&(this.isRendering=!0,requestAnimationFrame(()=>this.renderNextBatch())):this._removeSentinel()}ensureRendered(e){if(!(e===-1||e<this.renderedCount))for(;this.renderedCount<=e&&(this.renderNextBatch(),!(this.renderedCount>=this.items.length)););}_cleanup(){this.observer&&(this.observer.disconnect(),this.observer=null),this.container.innerHTML="",this.elementCache.clear(),this.renderedCount=0,this.currentPrefix=null,this.sentinel=null,this.isRendering=!1}_removeSentinel(){this.sentinel&&(this.sentinel.remove(),this.sentinel=null),this.observer&&(this.observer.disconnect(),this.observer=null),this.isRendering=!1}_getCurrentSection(){return this.sentinel&&this.sentinel.previousElementSibling&&this.sentinel.previousElementSibling.classList.contains("section")?this.sentinel.previousElementSibling:null}_appendFragment(e){this.sentinel&&this.sentinel.parentNode===this.container?this.container.insertBefore(e,this.sentinel):this.container.appendChild(e)}_getSectionPrefix(e){if(["title","subtitle","nidana"].includes(e.label))return"intro";if(e.label==="end")return"outro";if(e.label.startsWith("note"))return this.currentPrefix||"intro";const t=e.label.match(/^([a-z]+)/);return t?t[1]:"misc"}}class J{constructor(e,t){this.container=e,this.elementCache=t}update(e,t,i,s){if(!this.container||(this.container.querySelectorAll(".play-btn:not(.play-sequence-btn)").forEach(a=>{a.classList.remove("active-play"),a.innerHTML='<i class="fas fa-circle"></i>',a.title="Nghe ƒëo·∫°n n√†y"}),this.container.querySelectorAll(".play-sequence-btn").forEach(a=>{a.classList.remove("active-play"),a.innerHTML='<i class="fas fa-play-circle"></i>',a.title="Nghe to√†n b·ªô ph·∫ßn n√†y"}),!t||e==="stopped"))return;const n=this.elementCache.get(t);if(n){const a=n.querySelector(".play-btn:not(.play-sequence-btn)");a&&(a.classList.add("active-play"),a.innerHTML=e==="playing"?'<i class="fas fa-pause-circle"></i>':'<i class="fas fa-play-circle"></i>',a.title=e==="playing"?"T·∫°m d·ª´ng":"Ti·∫øp t·ª•c")}if(i&&s){const a=this.elementCache.get(s);if(a){const o=a.querySelector(".play-sequence-btn");o&&(o.classList.add("active-play"),o.innerHTML=e==="playing"?'<i class="fas fa-pause-circle"></i>':'<i class="fas fa-play-circle"></i>',o.title=e==="playing"?"T·∫°m d·ª´ng":"Ti·∫øp t·ª•c")}}}}class X{static build(e,t){if(!e||t<0||t>=e.length)return null;const i=e[t],s=i.html?i.html.match(/^<h(\d)>/i):null;if(!s)return null;const n=parseInt(s[1]),a=[];for(let o=t+1;o<e.length;o++){const r=e[o];if(r.label==="end")break;const l=r.html?r.html.match(/^<h(\d)>/i):null;if(l&&parseInt(l[1])<=n)break;r.audio&&r.audio!=="skip"&&a.push({id:r.id,audio:r.audio,text:r.text})}return{sequence:a,startId:i.id}}}class ee{constructor(e,t,i){this.container=document.getElementById(e),this.playSegmentCallback=t,this.playSequenceCallback=i,this.items=[],this.hoveredSegmentId=null,this.elementCache=new Map,this.maskManager=new j(this.container),this.segmentFactory=new G({playSegment:this.playSegmentCallback,playSequence:s=>this.playSequenceFromIndex(s),onMaskStart:(s,n,a)=>this.maskManager.handleMaskStart(s,n,a),onMaskEnter:(s,n)=>this.maskManager.handleMaskEnter(s,n),onHover:s=>{this.hoveredSegmentId=s}}),this.lazyRenderer=new Z(this.container,this.elementCache,this.segmentFactory),this.scrollManager=new z(this.container,this.elementCache,()=>this.items,s=>this.lazyRenderer.ensureRendered(s)),this.keyboardHandler=new Y(()=>this.hoveredSegmentId,()=>this.items,()=>this.elementCache,this.maskManager,this.playSegmentCallback,s=>this.playSequenceFromIndex(s)),this.playbackUI=new J(this.container,this.elementCache)}render(e){this.items=e||[],this.maskManager.setItems(this.items),this.scrollManager.clearHighlight(),this.lazyRenderer.render(this.items)}playSequenceFromIndex(e){if(!this.playSequenceCallback)return;const t=X.build(this.items,e);t&&t.sequence.length>0?this.playSequenceCallback(t.sequence,t.startId):alert("Kh√¥ng c√≥ d·ªØ li·ªáu √¢m thanh cho ph·∫ßn n√†y.")}scrollToSegment(e){this.scrollManager.scrollToSegment(e)}highlightSegment(e,t=!0,i="smart"){this.scrollManager.highlightSegment(e,t,i)}clearHighlight(){this.scrollManager.clearHighlight()}updatePlaybackState(e,t,i,s){this.playbackUI.update(e,t,i,s)}getFirstVisibleSegmentId(){if(!this.container)return null;const e=this.container.querySelectorAll(".segment");for(const t of e){const i=t.getBoundingClientRect();if(i.top+i.height>80&&i.top<window.innerHeight&&parseInt(t.dataset.id))return parseInt(t.dataset.id)}return null}}class te{constructor(e,t,i,s,n){this.playBtn=document.getElementById("play-all-btn"),this.pauseBtn=document.getElementById("pause-btn"),this.stopBtn=document.getElementById("stop-btn"),this.speedSelect=document.getElementById("speed-select"),this.loopBtn=document.getElementById("loop-btn"),this.hintToggleBtn=document.getElementById("hint-toggle-btn");const a="sutta_loop_enabled",o="tts_rate",r="sutta_hint_mode_enabled";if(this.playBtn&&this.playBtn.addEventListener("click",e),this.pauseBtn&&this.pauseBtn.addEventListener("click",t),this.stopBtn&&this.stopBtn.addEventListener("click",i),this.speedSelect){const l=localStorage.getItem(o);l&&(this.speedSelect.value=l),this.speedSelect.addEventListener("change",c=>{const h=parseFloat(c.target.value);localStorage.setItem(o,h),s(h)})}if(this.loopBtn&&(localStorage.getItem(a)==="true"&&this.loopBtn.classList.add("active"),this.loopBtn.addEventListener("click",()=>{const c=this.loopBtn.classList.toggle("active");localStorage.setItem(a,c),n&&n(c)})),this.hintToggleBtn){const l=localStorage.getItem(r);(l===null||l==="true")&&(this.hintToggleBtn.classList.add("active"),document.body.classList.add("hint-mode-active")),this.hintToggleBtn.addEventListener("click",()=>{const h=this.hintToggleBtn.classList.toggle("active");h?document.body.classList.add("hint-mode-active"):document.body.classList.remove("hint-mode-active"),localStorage.setItem(r,h)})}document.addEventListener("keydown",l=>{if(l.target.tagName==="INPUT"||l.target.tagName==="TEXTAREA"||l.target.isContentEditable)return;const c=l.key.toLowerCase();c==="g"&&this.loopBtn&&this.loopBtn.click(),c==="h"&&this.hintToggleBtn&&this.hintToggleBtn.click(),c==="t"&&this._changeSpeedIndex(1,s),c==="e"&&this._changeSpeedIndex(-1,s)})}_changeSpeedIndex(e,t){if(!this.speedSelect)return;const i=this.speedSelect.selectedIndex+e;if(i>=0&&i<this.speedSelect.options.length){this.speedSelect.selectedIndex=i;const s=parseFloat(this.speedSelect.value);localStorage.setItem("tts_rate",s),t&&t(s)}}updateState(e){if(!this.playBtn||!this.pauseBtn||!this.stopBtn)return;const t=this.pauseBtn.querySelector("i");switch(e){case"playing":this.playBtn.disabled=!0,this.pauseBtn.disabled=!1,this.stopBtn.disabled=!1,t&&(t.classList.remove("fa-play"),t.classList.add("fa-pause"));break;case"paused":this.playBtn.disabled=!0,this.pauseBtn.disabled=!1,this.stopBtn.disabled=!1,t&&(t.classList.remove("fa-pause"),t.classList.add("fa-play"));break;case"stopped":this.playBtn.disabled=!1,this.pauseBtn.disabled=!0,this.stopBtn.disabled=!0,t&&(t.classList.remove("fa-play"),t.classList.add("fa-pause"));break}}setSpeed(e){this.speedSelect&&(this.speedSelect.value=e.toString())}}class se{constructor(e){this.ttsEngine=e,this.modal=document.getElementById("settings-modal"),this.openBtn=document.getElementById("settings-btn"),this.closeBtn=document.querySelector(".close-modal"),this.form=document.getElementById("settings-form"),this.apiKeyInput=document.getElementById("api-key"),this.voiceSelect=document.getElementById("voice-select"),this.refreshVoicesBtn=document.getElementById("refresh-voices-btn"),this._setupListeners()}_setupListeners(){this.openBtn&&this.openBtn.addEventListener("click",e=>{e.preventDefault(),this._open()}),this.closeBtn&&this.closeBtn.addEventListener("click",e=>{e.preventDefault(),this._close()}),this.form&&this.form.addEventListener("submit",e=>{e.preventDefault(),this._save()}),this.refreshVoicesBtn&&this.refreshVoicesBtn.addEventListener("click",e=>{e.preventDefault(),this._loadVoices(!0)}),this.voiceSelect&&this.voiceSelect.addEventListener("change",e=>{this.ttsEngine.setVoice(e.target.value)}),window.addEventListener("click",e=>{e.target===this.modal&&this._close()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&!this.modal.classList.contains("hidden")&&this._close()})}_open(){try{this.modal.classList.remove("hidden"),this.ttsEngine&&(this.apiKeyInput&&(this.apiKeyInput.value=this.ttsEngine.getApiKey()||""),this._loadVoices(!1))}catch(e){console.error("Error opening settings modal:",e)}}_close(){this.modal.classList.add("hidden")}_save(){try{const e=this.apiKeyInput?this.apiKeyInput.value.trim():"";this.ttsEngine.setApiKey(e),this._close(),e?this._loadVoices(!0):this.voiceSelect&&(this.voiceSelect.innerHTML='<option value="" disabled selected>Vui l√≤ng nh·∫≠p API Key</option>')}catch(e){console.error("Error saving settings:",e)}}async _loadVoices(e){if(!this.ttsEngine||!this.ttsEngine.getApiKey()){this.voiceSelect&&(this.voiceSelect.innerHTML='<option value="" disabled selected>Vui l√≤ng nh·∫≠p API Key tr∆∞·ªõc</option>');return}this.voiceSelect&&(this.voiceSelect.innerHTML='<option value="" disabled selected>ƒêang t·∫£i...</option>'),this.refreshVoicesBtn&&(this.refreshVoicesBtn.disabled=!0,this.refreshVoicesBtn.innerHTML='<i class="fas fa-spin fa-spinner"></i>');try{const t=await this.ttsEngine.getVoices(e);if(this.voiceSelect){this.voiceSelect.innerHTML="";const i=this.ttsEngine.currentVoice,s=i?i.name:"";!t||t.length===0?this.voiceSelect.innerHTML='<option value="" disabled selected>Kh√¥ng t√¨m th·∫•y gi·ªçng ti·∫øng Vi·ªát</option>':(t.forEach(n=>{const a=document.createElement("option");a.value=n.name,a.textContent=`${n.name} (${n.ssmlGender})`,n.name===s&&(a.selected=!0),this.voiceSelect.appendChild(a)}),t.length>0&&!t.find(n=>n.name===s)&&(this.voiceSelect.selectedIndex=0,this.ttsEngine.setVoice(t[0].name)))}}catch(t){console.error("Error loading voices:",t),this.voiceSelect&&(this.voiceSelect.innerHTML='<option value="" disabled selected>L·ªói t·∫£i gi·ªçng</option>')}finally{this.refreshVoicesBtn&&(this.refreshVoicesBtn.disabled=!1,this.refreshVoicesBtn.innerHTML='<i class="fas fa-sync-alt"></i>')}}}const ie={init(){const d=document.getElementById("btn-toggle-drawer"),e=document.getElementById("control-drawer");d&&e&&(d.addEventListener("click",t=>{t.stopPropagation(),e.classList.toggle("hidden"),d.classList.toggle("open");const i=document.getElementById("control-bar");i&&i.classList.toggle("expanded")}),document.addEventListener("click",t=>{if(!e.classList.contains("hidden")&&!e.contains(t.target)&&!d.contains(t.target)){e.classList.add("hidden"),d.classList.remove("open");const s=document.getElementById("control-bar");s&&s.classList.remove("expanded")}}),e.addEventListener("click",t=>{t.stopPropagation()}))}},A={HUE_COEFF:"35deg",SATURATE:"60%",STORAGE_KEY_PREFIX:"sutta_sepia_"},ne={CONFIG:{STORAGE_KEY_THEME:"sutta_theme"},init(){const d=document.getElementById("btn-theme-toggle"),e=d?.querySelector(".icon-moon"),t=d?.querySelector(".icon-sun"),i=document.getElementById("sepia-control-panel"),s=document.getElementById("sepia-slider"),n=document.getElementById("btn-sepia-indicator");document.documentElement.style.setProperty("--sepia-hue-coeff",A.HUE_COEFF),document.documentElement.style.setProperty("--sepia-saturate",A.SATURATE);const a=window.matchMedia("(prefers-color-scheme: dark)").matches;let r=localStorage.getItem(this.CONFIG.STORAGE_KEY_THEME)||(a?"dark":"light");const l=g=>`${A.STORAGE_KEY_PREFIX}${g}`,c=()=>{if(!i)return;i.classList.contains("hidden")?(i.classList.remove("hidden"),n&&n.classList.add("panel-open")):(i.classList.add("hidden"),n&&n.classList.remove("panel-open"))},h=(g,p)=>{const f=p==="dark"?.2:.3;return g/100*f},u=(g,p)=>{const f=h(g,p);document.documentElement.style.setProperty("--sepia-overlay-opacity",f),s&&s.value!=g&&(s.value=g),n&&(n.textContent=`${g}%`)},m=g=>{document.documentElement.setAttribute("data-theme",g),localStorage.setItem(this.CONFIG.STORAGE_KEY_THEME,g),r=g,g==="dark"?(e?.classList.add("hidden"),t?.classList.remove("hidden")):(e?.classList.remove("hidden"),t?.classList.add("hidden"));const p=localStorage.getItem(l(g))||0;u(p,g)};m(r),n&&n.addEventListener("click",g=>{g.stopPropagation(),c()}),d&&d.addEventListener("click",()=>{m(r==="light"?"dark":"light"),i&&!i.classList.contains("hidden")&&c()}),s&&(s.addEventListener("input",g=>{const p=g.target.value;u(p,r),localStorage.setItem(l(r),p)}),document.addEventListener("click",g=>{i&&!i.classList.contains("hidden")&&!i.contains(g.target)&&!d.contains(g.target)&&(!n||!n.contains(g.target))&&c()}),i.addEventListener("click",g=>{g.stopPropagation()}))}},ae={MIN_SCALE:.8,MAX_SCALE:2,STEP:.1,DEFAULT_SCALE:1,STORAGE_KEY:"sutta_font_scale",init(){const d=document.getElementById("btn-font-decrease"),e=document.getElementById("btn-font-increase"),t=document.getElementById("font-size-label"),i=localStorage.getItem(this.STORAGE_KEY);let s=i?parseFloat(i):this.DEFAULT_SCALE;this.applyScale(s),d&&d.addEventListener("click",n=>{n.stopPropagation(),s>this.MIN_SCALE&&(s=Math.max(this.MIN_SCALE,s-this.STEP),this.applyScale(s))}),e&&e.addEventListener("click",n=>{n.stopPropagation(),s<this.MAX_SCALE&&(s=Math.min(this.MAX_SCALE,s+this.STEP),this.applyScale(s))}),t&&(t.addEventListener("click",n=>{n.stopPropagation(),s=this.DEFAULT_SCALE,this.applyScale(s)}),t.style.cursor="pointer")},applyScale(d){const e=Math.round(d*10)/10;document.documentElement.style.setProperty("--text-scale",e),localStorage.setItem(this.STORAGE_KEY,e)}},oe="modulepreload",re=function(d){return"/gioibon/"+d},B={},le=function(e,t,i){let s=Promise.resolve();if(t&&t.length>0){let r=function(l){return Promise.all(l.map(c=>Promise.resolve(c).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),o=a?.nonce||a?.getAttribute("nonce");s=r(t.map(l=>{if(l=re(l),l in B)return;B[l]=!0;const c=l.endsWith(".css"),h=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${h}`))return;const u=document.createElement("link");if(u.rel=c?"stylesheet":oe,c||(u.as="script"),u.crossOrigin="",u.href=l,o&&u.setAttribute("nonce",o),document.head.appendChild(u),c)return new Promise((m,g)=>{u.addEventListener("load",m),u.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${l}`)))})}))}function n(a){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=a,window.dispatchEvent(o),!o.defaultPrevented)throw a}return s.then(a=>{for(const o of a||[])o.status==="rejected"&&n(o.reason);return e().catch(n)})};function ce(d={}){const{immediate:e=!1,onNeedRefresh:t,onOfflineReady:i,onRegistered:s,onRegisteredSW:n,onRegisterError:a}=d;let o,r,l;const c=async(u=!0)=>{await r,l?.()};async function h(){if("serviceWorker"in navigator){if(o=await le(async()=>{const{Workbox:u}=await import("./vendor.BIl4cyR9.js");return{Workbox:u}},[]).then(({Workbox:u})=>new u("/gioibon/sw.js",{scope:"/gioibon/",type:"classic"})).catch(u=>{a?.(u)}),!o)return;l=()=>{o?.messageSkipWaiting()};{let u=!1;const m=()=>{u=!0,o?.addEventListener("controlling",g=>{g.isUpdate&&window.location.reload()}),t?.()};o.addEventListener("installed",g=>{typeof g.isUpdate>"u"?typeof g.isExternal<"u"&&g.isExternal?m():!u&&i?.():g.isUpdate||i?.()}),o.addEventListener("waiting",m)}o.register({immediate:e}).then(u=>{n?n("/gioibon/sw.js",u):s?.(u)}).catch(u=>{a?.(u)})}}return r=h(),c}function de(){console.log("[PWA] setupPWA called");const d=document.getElementById("btn-clear-cache");d&&d.addEventListener("click",async()=>{if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l√†m m·ªõi to√†n b·ªô d·ªØ li·ªáu? C√°c c·∫•u h√¨nh nh∆∞ API Key, font size v√† t·ªëc ƒë·ªô ƒë·ªçc s·∫Ω ƒë∆∞·ª£c gi·ªØ l·∫°i.")){d.disabled=!0,d.style.opacity="0.5";try{const r=["google_cloud_api_key","tts_voice_name","tts_rate","sutta_font_scale","sutta_theme","sutta_sepia_light","sutta_sepia_dark","sutta_loop_enabled","sutta_hint_mode_enabled"],l={};if(r.forEach(c=>{const h=localStorage.getItem(c);h!==null&&(l[c]=h)}),"serviceWorker"in navigator){const c=await navigator.serviceWorker.getRegistrations();for(let h of c)await h.unregister()}if("caches"in window){const c=await caches.keys();await Promise.all(c.map(h=>caches.delete(h)))}indexedDB.databases&&(await indexedDB.databases()).forEach(h=>{h.name&&indexedDB.deleteDatabase(h.name)}),localStorage.clear(),sessionStorage.clear(),Object.entries(l).forEach(([c,h])=>{localStorage.setItem(c,h)}),window.location.reload()}catch(r){console.error("L·ªói khi x√≥a cache:",r),alert("ƒê√£ x·∫£y ra l·ªói khi l√†m m·ªõi d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i."),d.disabled=!1,d.style.opacity="1"}}});const e=document.getElementById("pwa-toast"),t=document.getElementById("pwa-refresh"),i=document.getElementById("pwa-close"),s=document.getElementById("btn-update-app"),n=()=>{e&&e.classList.remove("hidden"),s&&(s.classList.remove("rotating"),s.classList.add("update-available"),s.title="C√≥ b·∫£n c·∫≠p nh·∫≠t m·ªõi!")};console.log("[PWA] Attempting to register SW unconditionally...");const a=ce({onNeedRefresh(){console.log("[PWA] App update needed (SW)"),n()},onOfflineReady(){console.log("[PWA] Offline ready")},onRegisterError(r){console.error("[PWA] Registration error:",r)}}),o=async()=>{try{const r=`${E}app-content/content_version.json?t=${Date.now()}`,l=await fetch(r,{cache:"no-store"});if(l.ok){const c=await l.json(),h=localStorage.getItem("db_version_content.db");if(h&&c.version!==h)return!0}}catch{}return!1};if(document.addEventListener("visibilitychange",async()=>{if(document.visibilityState==="visible"){if("serviceWorker"in navigator){const r=await navigator.serviceWorker.getRegistration();r&&r.update()}await o()&&(console.log("[PWA] Data update found in background."),n())}}),e&&t&&i){const r=()=>{t.disabled=!0,t.textContent="ƒêang t·∫£i...",i.disabled=!0,a(!0),setTimeout(()=>{window.location.reload()},1e3)};t.addEventListener("click",r),s&&s.addEventListener("click",async()=>{if(!e.classList.contains("hidden")){r();return}s.classList.add("rotating"),s.title="ƒêang ki·ªÉm tra...";let l=!1;l=await o();try{if("serviceWorker"in navigator){const c=await navigator.serviceWorker.getRegistration();c&&(await c.update(),(c.installing||c.waiting)&&(l=!0))}}catch(c){console.error("[PWA] Manual SW update check failed:",c)}l?n():(s.classList.remove("rotating"),s.title="Ki·ªÉm tra & C·∫≠p nh·∫≠t",alert("·ª®ng d·ª•ng v√† d·ªØ li·ªáu ƒë√£ ·ªü phi√™n b·∫£n m·ªõi nh·∫•t."))}),i.addEventListener("click",()=>{e.classList.add("hidden")})}}class R{constructor(e){this.contentLoader=e,this.isProcessing=!1,this.cacheName="audio-mp3-cache"}async loadAndInject(){if(!this.isProcessing){this.isProcessing=!0;try{if(!("caches"in window))return;const e=await caches.open(this.cacheName),t=this.contentLoader.getAllSegments(),i=[...new Set(t.map(p=>p.audio).filter(p=>p&&p!=="skip"))],s=await e.keys();let n=0;const a=new Set;for(const p of s){const S=new URL(p.url).pathname.split("/").pop();S&&S.endsWith(".mp3")&&(i.includes(S)?a.add(S):(await e.delete(p),n++))}n>0&&console.log(`üóëÔ∏è ƒê√£ d·ªçn d·∫πp ${n} file audio c≈© kh·ªèi Cache.`);const o=i.filter(p=>!a.has(p));if(o.length===0){console.log("‚ú® To√†n b·ªô d·ªØ li·ªáu √¢m thanh ƒë√£ s·∫µn s√†ng (Cached).");return}console.log(`‚¨áÔ∏è Thi·∫øu ${o.length} file. B·∫Øt ƒë·∫ßu t·∫£i v√† gi·∫£i n√©n audio.zip...`);const r=`${E}app-content/audio.zip?t=${Date.now()}`;let l;try{l=await fetch(r)}catch(p){console.warn(`‚ö†Ô∏è ƒêang ngo·∫°i tuy·∫øn ho·∫∑c l·ªói k·∫øt n·ªëi. S·∫Ω t·∫£i audio.zip sau. (${p.message})`);return}if(!l.ok){console.warn(`‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i audio.zip (${l.status}). S·∫Ω t·∫£i l·∫°i sau.`);return}const c=await l.blob(),h=window.JSZip;if(!h){console.error("‚ùå Th∆∞ vi·ªán JSZip ch∆∞a ƒë∆∞·ª£c t·∫£i v√†o global.");return}const m=await new h().loadAsync(c);let g=0;for(const p of o){const f=m.file(p);if(f){const S=await f.async("blob"),x=`${window.location.origin}${E}app-content/audio/${p}`,N=new Response(S,{status:200,statusText:"OK",headers:{"Content-Type":"audio/mpeg","Content-Length":S.size.toString(),"Accept-Ranges":"bytes","Cache-Control":"max-age=31536000"}});await e.put(x,N),g++}}console.log(`‚úÖ ƒê√£ gi·∫£i n√©n v√† l∆∞u tr·ª±c ti·∫øp ${g} file √¢m thanh v√†o Cache ƒë·ªÉ d√πng Offline.`)}catch(e){console.error("‚ùå L·ªói khi ch·∫°y Audio Zip Loader:",e)}finally{this.isProcessing=!1}}}}const w={updateStatus(d){const e=document.querySelector("#splash-screen .splash-subtitle");e&&(e.textContent=d)},hide(){const d=document.getElementById("splash-screen");d&&(d.classList.add("splash-hidden"),setTimeout(()=>{d.parentNode&&d.parentNode.removeChild(d)},500))}};document.addEventListener("DOMContentLoaded",async()=>{de(),await new Promise(o=>setTimeout(o,150));const d=new M,e=new K(d),t=new F(d),i=localStorage.getItem("sutta_loop_enabled")==="true";t.isLooping=i,ie.init(),ne.init(),ae.init();const s=new ee("content",(o,r,l)=>{t.playSegment(o,r,l)},(o,r)=>{t.playSequence(o,r)}),n=new W("toc-list","sidebar","sidebar-toggle",s),a=new te(()=>{if(t.isPaused)t.resume();else{const o=s.getFirstVisibleSegmentId();if(o){const r=e.getSegmentsStartingFrom(o);r.length>0&&t.playSequence(r)}else{const r=e.getAllSegments();r.length>0&&t.playSequence(r)}}},()=>{t.isPlaying?t.pause():t.isPaused&&t.resume()},()=>{t.stop()},o=>{t.setRate(o)},o=>{t.isLooping=o});a.setSpeed(t.currentRate),new se(t.engine),t.onSegmentStart=(o,r)=>{s.highlightSegment(o,r),s.updatePlaybackState(t.isPlaying?"playing":"paused",o,r,t.sequenceParentId)},t.onPlaybackEnd=()=>{s.clearHighlight(),a.updateState("stopped"),s.updatePlaybackState("stopped",null,!1,null)},t.onPlaybackStateChange=o=>{a.updateState(o),s.updatePlaybackState(o,t.currentSegmentId,t.isSequence,t.sequenceParentId)};try{w.updateStatus("ƒêang t·∫£i c∆° s·ªü d·ªØ li·ªáu...");const o=await e.load();w.updateStatus("ƒêang s·∫Øp x·∫øp n·ªôi dung..."),s.render(o),n.render(o),w.hide(),"requestIdleCallback"in window?requestIdleCallback(()=>{new R(e).loadAndInject()}):setTimeout(()=>{new R(e).loadAndInject()},3e3)}catch(o){console.error("Initialization Error:",o),w.hide(),document.getElementById("content").innerHTML='<div class="error" style="text-align: center; margin-top: 50px; color: red;">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra l·∫°i ƒë∆∞·ªùng truy·ªÅn v√† th·ª≠ l·∫°i sau.</div>'}});
