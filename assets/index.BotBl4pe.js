import{i as _,u as L,w,a as A}from"./vendor-sqlite.CXrIRBlc.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();const R={},v=R?"/gioibon/":"/",f={API_KEY:"google_cloud_api_key",TTS_VOICE:"tts_voice_name",TTS_RATE:"tts_rate",TTS_CACHE_LIST:"tts_gcloud_voices_list",TTS_CACHE_TS:"tts_gcloud_voices_ts"},b={VOICE_LANG:"vi-VN",VOICE_NAME:"vi-VN-Chirp3-HD-Charon",RATE:1.5,CACHE_DURATION:10080*60*1e3},C={TTS:"https://texttospeech.googleapis.com/v1/text:synthesize",VOICES:"https://texttospeech.googleapis.com/v1/voices"},k={SCROLL_THRESHOLD_TOP:80,SCROLL_THRESHOLD_BOTTOM:80,SCROLL_BEHAVIOR:"smooth"};class B{constructor(e="content.db",t=`${v}app-content/content.db`){this.dbName=e,this.dbUrl=t,this.db=null}async init(){if(this.db)return this.db;try{const e=this.dbUrl.replace(/\.db$/,"_version.json"),t=`db_version_${this.dbName}`,i=localStorage.getItem(t);let s=!1,n=null;try{const o=await fetch(`${e}?t=${Date.now()}`,{cache:"no-store"});o.ok?(n=await o.json(),n.version!==i&&(s=!0)):s=!i}catch{s=!i}if(s){const o=await fetch(`${this.dbUrl}?t=${Date.now()}`,{cache:"no-store"});if(!o.ok)throw new Error(`Failed to download DB: ${o.status}`);const a=await o.arrayBuffer(),r=new File([a],this.dbName),l=await _(L(this.dbName,{...A(r),url:w}));n&&localStorage.setItem(t,n.version),this.db=l;try{await l.run("PRAGMA cache_size = 500"),await l.run("PRAGMA temp_store = MEMORY"),await l.run("PRAGMA synchronous = OFF"),await l.run("PRAGMA mmap_size = 0"),await l.run("PRAGMA query_only = 1")}catch{}}else{const o=await _(L(this.dbName,{url:w}));try{if((await o.run("SELECT name FROM sqlite_master WHERE type='table' AND name='contents'")).length===0)return localStorage.removeItem(t),this.db=null,await this.forceDownload();await o.run("PRAGMA cache_size = 500"),await o.run("PRAGMA temp_store = MEMORY"),await o.run("PRAGMA mmap_size = 0"),await o.run("PRAGMA query_only = 1")}catch{return localStorage.removeItem(t),this.db=null,await this.forceDownload()}this.db=o}return this.db}catch(e){throw e}}async forceDownload(){const e=await fetch(`${this.dbUrl}?t=${Date.now()}`,{cache:"no-store"});if(!e.ok)throw new Error(`Failed to download DB: ${e.status}`);const t=await e.arrayBuffer(),i=new File([t],this.dbName);this.db=await _(L(this.dbName,{...A(i),url:w}));try{const s=this.dbUrl.replace(/\.db$/,"_version.json"),n=await fetch(`${s}?t=${Date.now()}`,{cache:"no-store"});if(n.ok){const o=await n.json();localStorage.setItem(`db_version_${this.dbName}`,o.version)}}catch{}try{await this.db.run("PRAGMA cache_size = 500"),await this.db.run("PRAGMA temp_store = MEMORY"),await this.db.run("PRAGMA mmap_size = 0"),await this.db.run("PRAGMA query_only = 1")}catch{}return this.db}async query(e,t=[]){return this.db||await this.init(),await this.db.run(e,t)}}class M{constructor(){this.apiKey=localStorage.getItem(f.API_KEY)||"",this.cachedVoices=this._loadVoicesFromCache(),this.voice={languageCode:b.VOICE_LANG,name:localStorage.getItem(f.TTS_VOICE)||b.VOICE_NAME},this.rate=parseFloat(localStorage.getItem(f.TTS_RATE))||b.RATE}setApiKey(e){this.apiKey=e,localStorage.setItem(f.API_KEY,e)}getApiKey(){return this.apiKey}hasApiKey(){return!!this.apiKey&&this.apiKey.length>0}setVoice(e,t="vi-VN"){this.voice={name:e,languageCode:t},localStorage.setItem(f.TTS_VOICE,e)}setRate(e){this.rate=e,localStorage.setItem(f.TTS_RATE,e)}_loadVoicesFromCache(){const e=localStorage.getItem(f.TTS_CACHE_LIST);if(e)try{return JSON.parse(e)}catch{}return[]}async getVoices(e=!1){if(!this.apiKey)return[];const t=parseInt(localStorage.getItem(f.TTS_CACHE_TS)||"0"),i=Date.now();if(!e&&this.cachedVoices.length>0&&i-t<b.CACHE_DURATION)return this.cachedVoices;try{const s=await fetch(`${C.VOICES}?key=${this.apiKey}&languageCode=vi-VN`);if(!s.ok)return this.cachedVoices.length>0?this.cachedVoices:[];const a=((await s.json()).voices||[]).filter(r=>r.languageCodes.includes("vi-VN"));return a.length>0&&(this.cachedVoices=a,localStorage.setItem(f.TTS_CACHE_LIST,JSON.stringify(a)),localStorage.setItem(f.TTS_CACHE_TS,i.toString())),a}catch{return this.cachedVoices.length>0?this.cachedVoices:[]}}async fetchAudioBlob(e){if(!this.apiKey)throw new Error("Vui lòng nhập Google Cloud API Key trong phần Cài đặt.");const t={input:{text:e},voice:{languageCode:this.voice.languageCode,name:this.voice.name},audioConfig:{audioEncoding:"MP3",speakingRate:this.rate,pitch:0}};try{const i=await fetch(`${C.TTS}?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!i.ok){const n=await i.json().catch(()=>({}));throw new Error(n.error?.message||`API Error: ${i.status}`)}const s=await i.json();if(s.audioContent){const n=atob(s.audioContent),o=new Uint8Array(n.length);for(let a=0;a<n.length;a++)o[a]=n.charCodeAt(a);return new Blob([o],{type:"audio/mp3"})}throw new Error("No audio content received")}catch(i){throw i}}async fetchAudio(e){const t=await this.fetchAudioBlob(e);return new Promise((i,s)=>{const n=new FileReader;n.onloadend=()=>i(n.result),n.onerror=s,n.readAsDataURL(t)})}}class x{constructor(){this.ttsRules=null,this.rulesPromise=this._loadRules()}async _loadRules(){try{const e=await fetch(`${v}app-content/tts_rules.json`);e.ok&&(this.ttsRules=await e.json())}catch{}}async normalize(e){if(!e)return"";if(await this.rulesPromise,!this.ttsRules)return e;let t=e;if(this.ttsRules.remove_html&&(t=t.replace(/<[^>]*>?/gm,"")),this.ttsRules.remove_chars){const i=this.ttsRules.remove_chars.map(n=>this._escapeRegExp(n)).join(""),s=new RegExp(`[${i}]`,"g");t=t.replace(s," ")}if(this.ttsRules.collapse_spaces&&(t=t.replace(/\s+/g," ").trim()),this.ttsRules.phonetics)for(const[i,s]of Object.entries(this.ttsRules.phonetics)){const n=new RegExp(this._escapeRegExp(i),"gi");t=t.replace(n,s)}return this.ttsRules.capitalize_upper&&this._isUpper(t)&&(t=this._capitalize(t)),t}_escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}_isUpper(e){return e===e.toUpperCase()&&e!==e.toLowerCase()}_capitalize(e){return e&&e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()}}const N="tts_audio_cache",S="audios",O=1;class H{constructor(){this.db=null,this.initPromise=this.init()}async init(){if(!this.db)return new Promise((e,t)=>{const i=indexedDB.open(N,O);i.onupgradeneeded=s=>{const n=s.target.result;n.objectStoreNames.contains(S)||n.createObjectStore(S,{keyPath:"hash"})},i.onsuccess=s=>{this.db=s.target.result,e()},i.onerror=s=>{t(s.target.error)}})}async generateHash(e,t,i){if(!e)return null;const s=`${e}|${t}|${i}`,o=new TextEncoder().encode(s),a=await crypto.subtle.digest("SHA-256",o);return Array.from(new Uint8Array(a)).map(c=>c.toString(16).padStart(2,"0")).join("").substring(0,16)}async get(e){return await this.initPromise,new Promise((t,i)=>{const o=this.db.transaction([S],"readonly").objectStore(S).get(e);o.onsuccess=()=>{t(o.result?o.result.blob:null)},o.onerror=()=>i(o.error)})}async set(e,t){return await this.initPromise,new Promise((i,s)=>{const o=this.db.transaction([S],"readwrite").objectStore(S),a={hash:e,blob:t,timestamp:Date.now()},r=o.put(a);r.onsuccess=()=>i(),r.onerror=()=>s(r.error)})}async has(e){return!!await this.get(e)}}const E=new H;class D{constructor(e,t){this.engine=e,this.dbConnection=t}async resolve(e,t,i,s){const n=await s.normalize(e.text);if(t!==i()||!n)return null;const o=this.engine.voice.name,a=this.engine.voice.languageCode,r=await E.generateHash(n,o,a);if(e.audio&&e.audio!=="skip")return{url:`${v}app-content/audio/${e.audio}`,isBlob:!1};if(await E.has(r)){if(t!==i())return null;const l=await E.get(r);return{url:URL.createObjectURL(l),isBlob:!0}}if(this.engine.hasApiKey())try{const l=await this.engine.fetchAudioBlob(n);return t!==i()?null:(await E.set(r,l),{url:URL.createObjectURL(l),isBlob:!0})}catch{}return null}}class q{constructor(e){this.engine=new M,this.textProcessor=new x,this.audioResolver=new D(this.engine,e),this.audioElement=new Audio,this.audioQueue=[],this.isPlaying=!1,this.isPaused=!1,this.currentAudio=this.audioElement,this.currentSegmentId=null,this.isSequence=!1,this.sequenceParentId=null,this.isLooping=!1,this.currentPlaylist=[],this.onSegmentStart=null,this.onSegmentEnd=null,this.onPlaybackEnd=null,this.onPlaybackStateChange=null,this.playbackSessionId=0,this.preloadMap=new Map,this.preloadDepth=2,this.currentBlobUrl=null}setApiKey(e){this.engine.setApiKey(e)}getApiKey(){return this.engine.getApiKey()}setVoice(e){this.engine.setVoice(e)}setRate(e){this.engine.setRate(e)}getVoices(e){return this.engine.getVoices(e)}get currentVoice(){return this.engine.voice}get currentRate(){return this.engine.rate}playSegment(e,t,i){if(String(this.currentSegmentId)===String(e)&&(this.isPlaying||this.isPaused)){this.togglePause();return}this._startNewSession(),this.isSequence=!1;const s={id:e,audio:t,text:i};this.audioQueue=[s],this.currentPlaylist=[s],this._processQueue()}playSequence(e,t=null){if(this.isSequence&&e.length>0&&this.currentPlaylist.length>0&&String(this.currentPlaylist[0].id)===String(e[0].id)&&(this.isPlaying||this.isPaused)){this.togglePause();return}this._startNewSession(),this.isSequence=!0,this.sequenceParentId=t,this.audioQueue=[...e],this.currentPlaylist=[...e],this._processQueue()}pause(){this.audioElement.paused||(this.audioElement.pause(),this.isPaused=!0,this.isPlaying=!1,this._emitState("paused"))}resume(){this.audioElement.paused&&this.isPaused?(this.audioElement.play(),this.isPaused=!1,this.isPlaying=!0,this._emitState("playing")):this.audioQueue.length>0&&!this.isPlaying&&!this.isPaused&&this._processQueue()}togglePause(){this.isPaused?this.resume():this.pause()}stop(){this._cleanupSession(),this.audioQueue=[],this.currentPlaylist=[],this.sequenceParentId=null,this.audioElement.pause(),this.audioElement.currentTime=0,this.audioElement.removeAttribute("src"),this.audioElement.load(),this._revokeCurrentBlob(),this.isPlaying=!1,this.isPaused=!1,this.currentSegmentId=null,this.isSequence=!1,this.onPlaybackEnd&&this.onPlaybackEnd(),this._emitState("stopped")}_startNewSession(){this._cleanupSession(),this.playbackSessionId++}_cleanupSession(){for(const e of this.preloadMap.values())URL.revokeObjectURL(e);this.preloadMap.clear()}_revokeCurrentBlob(){this.currentBlobUrl&&(URL.revokeObjectURL(this.currentBlobUrl),this.currentBlobUrl=null)}_getCurrentSessionId(){return this.playbackSessionId}async _preloadNextItem(){if(this.audioQueue.length===0)return;const e=this.playbackSessionId;for(let t=0;t<Math.min(this.preloadDepth,this.audioQueue.length);t++){const i=this.audioQueue[t];if(!this.preloadMap.has(i.id)){const s=await this.audioResolver.resolve(i,e,()=>this.playbackSessionId,this.textProcessor);s&&s.isBlob&&this.playbackSessionId===e&&this.preloadMap.set(i.id,s.url)}}}async _processQueue(){if(this.audioQueue.length===0)if(this.isLooping&&this.currentPlaylist.length>0)this.audioQueue=[...this.currentPlaylist];else{this.stop();return}if(this.isPaused)return;this._revokeCurrentBlob(),this.isPlaying=!0,this._emitState("playing");const e=this.audioQueue.shift();this.currentSegmentId=e.id,this.onSegmentStart&&this.onSegmentStart(e.id,this.isSequence);try{const t=this.playbackSessionId;let i=null,s=!1;if(this.preloadMap.has(e.id))i=this.preloadMap.get(e.id),s=!0,this.preloadMap.delete(e.id);else{const o=await this.audioResolver.resolve(e,t,()=>this.playbackSessionId,this.textProcessor);o&&(i=o.url,s=o.isBlob)}if(t!==this.playbackSessionId)return;if(!i){this._handleSegmentEnd(e.id,null);return}s&&(this.currentBlobUrl=i),this.audioElement.src=i,this.engine.rate&&(this.audioElement.playbackRate=this.engine.rate);const n=()=>{this._revokeCurrentBlob(),this._handleSegmentEnd(e.id)};this.audioElement.onended=n,this.audioElement.onerror=o=>{n()},await this.audioElement.play(),this._preloadNextItem()}catch{this._handleSegmentEnd(e.id)}}_handleSegmentEnd(e){this.onSegmentEnd&&this.onSegmentEnd(e),this._processQueue()}_emitState(e){this.onPlaybackStateChange&&this.onPlaybackStateChange(e)}}class V{constructor(e){this.db=e||new B,this.data=null}async load(){if(this.data)return this.data;try{this.data=[];let t=0,i=!0;for(;i;){const s=await this.db.query(`SELECT uid, html, label, audio_name, 
                     CASE WHEN hint IS NOT NULL AND hint != '' THEN hint ELSE segment END as text 
                     FROM contents WHERE uid > ${t} ORDER BY uid ASC LIMIT 100`);if(s&&s.length>0){const n=s.map(o=>({id:o.uid,html:o.html,label:o.label,audio:o.audio_name,text:o.text}));this.data.push(...n),t=s[s.length-1].uid,await new Promise(o=>setTimeout(o,5))}else i=!1}return this.data}catch(e){throw e}}getAllSegments(){return this.data?this.data.filter(e=>e.audio!=="skip").map(e=>({id:e.id,audio:e.audio,text:e.text})):[]}getSegmentsStartingFrom(e){if(!this.data)return[];let t=0;return e&&(t=this.data.findIndex(s=>s.id===e),t===-1&&(t=0)),this.data.slice(t).filter(s=>s.audio!=="skip").map(s=>({id:s.id,audio:s.audio,text:s.text}))}getSegment(e){return this.data?.find(t=>t.id===e)}getSegmentsByLabelPrefix(e){return this.data?this.data.filter(t=>t.label.startsWith(e)):[]}getRuleSegments(e,t){return[]}}class K{constructor(e,t,i,s){this.container=document.getElementById(e),this.sidebar=document.getElementById(t),this.toggle=document.getElementById(i),this.contentRenderer=s,this.activeLink=null}render(e){if(!this.container)return;this.container.innerHTML="";const t=document.createElement("ul");t.className="toc-main-list",this.container.appendChild(t);let i=null,s=null,n=null;e.forEach(o=>{const a=o.html?o.html.match(/^<h(\d)>(.*?)<\/h\d>/i):null,r=o.label.endsWith("-name");if(a||r){let l=a?parseInt(a[1]):4;r&&(l=4);let c=(o.text||"").replace(/<[^>]*>?/gm,"").trim();if(!c&&!r)return;const g=this._createLink(o,c,l);if(l===1){const d=document.createElement("li");d.className="toc-item level-title",d.appendChild(g),t.appendChild(d),i=null,s=null,n=null}else if(l===2){const d=document.createElement("li");d.className="toc-item level-h2",d.appendChild(g),t.appendChild(d),i=d,s=null,n=null}else if(l===3){const d=document.createElement("li");d.className="toc-item level-h3",d.appendChild(g),t.appendChild(d),s=d,n=null}else if(l===4){const d=s||i;if(d){(!n||n.parentElement!==d)&&(n=document.createElement("ul"),n.className="toc-rule-list",d.appendChild(n));let p=c;const u=c.match(/^(\d+)\./)||c.match(/^(\d+)$/)||c.match(/(\d+)$/);if(u)p=u[1];else{const y=o.label.match(/([a-z]+)(\d+)-name/i);y&&(p=y[2])}p.length>3&&(p=p.substring(0,3)),g.textContent=p,g.title=c,g.className="toc-link rule-link";const m=document.createElement("li");m.className="toc-rule-item",m.appendChild(g),n.appendChild(m)}}}}),this._setupToggle()}_createLink(e,t,i){const s=document.createElement("a");return s.className="toc-link",s.href=`#segment-${e.id}`,s.dataset.id=e.id,s.textContent=t,s.onclick=n=>{n.preventDefault(),this._handleLinkClick(e.id,s)},s}_handleLinkClick(e,t){this.contentRenderer&&this.contentRenderer.scrollToSegment(e),this._setActive(t),window.innerWidth<=1024&&this.sidebar&&this.sidebar.classList.remove("visible")}_setActive(e){this.container&&this.container.querySelectorAll(".toc-link").forEach(t=>t.classList.remove("active")),e.classList.add("active"),this.activeLink=e}_setupToggle(){if(!this.toggle)return;const e=this.toggle.cloneNode(!0);this.toggle.parentNode.replaceChild(e,this.toggle),this.toggle=e,this.toggle.addEventListener("click",()=>{this.sidebar.classList.toggle("visible")}),document.addEventListener("click",t=>{window.innerWidth<=1024&&this.sidebar&&!this.sidebar.contains(t.target)&&!this.toggle.contains(t.target)&&this.sidebar.classList.contains("visible")&&this.sidebar.classList.remove("visible")})}}class U{constructor(e){this.callbacks=e}create(e,t){const i=document.createElement("div");i.className="segment",i.dataset.id=e.id,i.dataset.label=e.label,i.dataset.index=t,i.addEventListener("mouseenter",()=>{this.callbacks.onHover&&this.callbacks.onHover(e.id)}),this._applyClasses(i,e);const s=document.createElement("div");return s.className="segment-content-wrapper",this._addPlayButtons(s,e,t),this._addTextContent(s,e),i.appendChild(s),this._addMaskToggle(i,e),i}_applyClasses(e,t){t.label.endsWith("-name")?e.classList.add("rule-header"):t.label.endsWith("-chapter")?e.classList.add("chapter-header"):t.label==="title"&&e.classList.add("main-title"),t.html&&t.html.match(/^<h[1-6]/i)&&e.classList.add("heading-segment"),t.html&&t.html.match(/class=['"](endsection|endvagga|endsutta|sadhu|namo)['"]/)&&e.classList.add("end-segment")}_addPlayButtons(e,t,i){if(t.audio&&t.audio!=="skip"){const s=document.createElement("button");s.id=`play-btn-${t.id}`,s.name=`play-btn-${t.id}`,s.className="play-btn icon-btn",s.innerHTML='<i class="fas fa-circle"></i>',s.title="Nghe đoạn này",s.onclick=n=>{n.stopPropagation(),this.callbacks.playSegment&&this.callbacks.playSegment(t.id,t.audio,t.text)},e.appendChild(s)}if(t.html&&t.html.match(/^<h[1-6]/i)&&t.label!=="title"&&t.label!=="subtitle"){const s=document.createElement("button");s.id=`play-seq-btn-${t.id}`,s.name=`play-seq-btn-${t.id}`,s.className="play-btn icon-btn play-sequence-btn",s.innerHTML='<i class="fas fa-play-circle"></i>',s.title="Nghe toàn bộ phần này",s.onclick=n=>{n.stopPropagation(),this.callbacks.playSequence&&this.callbacks.playSequence(i)},e.appendChild(s)}}_addTextContent(e,t){const i=document.createElement("div");i.className="segment-text";const n=(t.html||"{}").replace("{}",t.text||"");i.innerHTML=n,e.appendChild(i)}_addMaskToggle(e,t){const i=t.html&&t.html.match(/^<h[1-6]/i)&&t.label!=="title"&&t.label!=="subtitle";if(t.audio&&t.audio!=="skip"||i){const n=document.createElement("div");n.className="segment-mask-toggle",n.title="Nhấp để che/hiện text",this.callbacks.onMaskStart&&(n.addEventListener("mousedown",o=>this.callbacks.onMaskStart(o,e,t)),n.addEventListener("touchstart",o=>this.callbacks.onMaskStart(o,e,t),{passive:!1})),this.callbacks.onMaskEnter&&n.addEventListener("mouseenter",o=>this.callbacks.onMaskEnter(o,e)),e.appendChild(n)}}}class ${constructor(e){this.container=e,this.items=[],this.isDraggingMask=!1,this.dragMaskAction=null,this.lastActionTime=0,this.cooldownMs=250,this._setupGlobalListeners()}setItems(e){this.items=e}_setupGlobalListeners(){const e=()=>{this.isDraggingMask=!1,this.dragMaskAction=null};document.addEventListener("mouseup",e),document.addEventListener("touchend",e)}_isHeading(e){return e.html&&e.html.match(/^<h[1-6]/i)&&e.label!=="title"&&e.label!=="subtitle"}toggleMask(e,t){const i=Date.now();if(i-this.lastActionTime<this.cooldownMs)return;this.lastActionTime=i;const s=e.querySelector(".segment-text");if(!s)return;if(this._isHeading(t)){this._toggleHeadingMask(e,t);return}const n=s.classList.contains("masked");this._applyMaskAction(s,n?"unmask":"mask")}handleMaskStart(e,t,i){if(e.type==="mousedown"&&e.button!==0)return;const s=Date.now();if(s-this.lastActionTime<this.cooldownMs){e&&e.cancelable&&e.preventDefault();return}this.lastActionTime=s,e&&e.cancelable&&e.preventDefault(),this.isDraggingMask=!0;const n=t.querySelector(".segment-text");if(this._isHeading(i)){this._toggleHeadingMask(t,i);return}const o=n.classList.contains("masked");this.dragMaskAction=o?"unmask":"mask",this._applyMaskAction(n,this.dragMaskAction)}handleMaskEnter(e,t){if(!this.isDraggingMask||!this.dragMaskAction)return;const i=t.dataset.id,s=this.items.find(o=>String(o.id)===String(i));if(s&&this._isHeading(s))return;const n=t.querySelector(".segment-text");this._applyMaskAction(n,this.dragMaskAction)}_applyMaskAction(e,t){t==="mask"?e.classList.add("masked"):e.classList.remove("masked")}_toggleHeadingMask(e,t){const i=parseInt(e.dataset.index),s=t.html.match(/^<h(\d)>/i);if(!s)return;const n=parseInt(s[1]);let o="mask";for(let a=i+1;a<this.items.length;a++){const r=this.items[a];if(r.label==="end")break;const l=r.html?r.html.match(/^<h(\d)>/i):null;if(l){if(parseInt(l[1])<=n)break;continue}const c=this._findElement(r.id);if(c){const g=c.querySelector(".segment-text");if(g){o=g.classList.contains("masked")?"unmask":"mask";break}}}for(let a=i+1;a<this.items.length;a++){const r=this.items[a];if(r.label==="end")break;const l=r.html?r.html.match(/^<h(\d)>/i):null;if(l){if(parseInt(l[1])<=n)break;continue}const c=this._findElement(r.id);if(c){const g=c.querySelector(".segment-text");g&&this._applyMaskAction(g,o)}}}_findElement(e){return this.container.querySelector(`.segment[data-id="${e}"]`)}}const F=60;class G{constructor(e,t,i){this.container=document.getElementById(e),this.playSegmentCallback=t,this.playSequenceCallback=i,this.items=[],this.hoveredSegmentId=null,this.elementCache=new Map,this.activeSegmentId=null,this.maskManager=new $(this.container),this.segmentFactory=new U({playSegment:this.playSegmentCallback,playSequence:s=>this._handlePlaySequence(s),onMaskStart:(s,n,o)=>this.maskManager.handleMaskStart(s,n,o),onMaskEnter:(s,n)=>this.maskManager.handleMaskEnter(s,n),onHover:s=>{this.hoveredSegmentId=s}}),this.renderedCount=0,this.observer=null,this.sentinel=null,this.currentPrefix=null,this.isRendering=!1,this._setupKeyboardListeners()}_setupKeyboardListeners(){document.addEventListener("keydown",e=>{if(e.target.tagName==="INPUT"||e.target.tagName==="SELECT")return;const t=e.key.toLowerCase();t==="r"?this._handleKeyboardPlay():t==="f"&&this._handleKeyboardFlip()})}render(e){if(this.container){if(this.observer&&(this.observer.disconnect(),this.observer=null),this.container.innerHTML="",this.elementCache.clear(),this.activeSegmentId=null,this.renderedCount=0,this.currentPrefix=null,this.sentinel=null,this.isRendering=!1,this.items=e||[],this.maskManager.setItems(this.items),!this.items||this.items.length===0){this.container.innerHTML='<div class="empty">Không có dữ liệu hiển thị.</div>';return}this.sentinel=document.createElement("div"),this.sentinel.className="loading-sentinel",this.sentinel.style.height="50px",this.sentinel.style.width="100%",this.container.appendChild(this.sentinel),this.observer=new IntersectionObserver(t=>{t[0].isIntersecting&&(this.isRendering||(this.isRendering=!0,requestAnimationFrame(()=>this._renderNextBatch())))},{root:this.container,rootMargin:"200px",threshold:.1}),this.observer.observe(this.sentinel),this._renderNextBatch()}}_renderNextBatch(){if(this.renderedCount>=this.items.length){this.sentinel&&this.sentinel.remove(),this.observer&&this.observer.disconnect(),this.isRendering=!1;return}const e=this.items.slice(this.renderedCount,this.renderedCount+F),t=document.createDocumentFragment();let i=null;this.sentinel&&this.sentinel.previousElementSibling&&this.sentinel.previousElementSibling.classList.contains("section")&&(i=this.sentinel.previousElementSibling),e.forEach((s,n)=>{const o=this.renderedCount+n;let a="misc";if(["title","subtitle","nidana"].includes(s.label))a="intro";else if(s.label==="end")a="outro";else if(s.label.startsWith("note"))a=this.currentPrefix||"intro";else{const c=s.label.match(/^([a-z]+)/);c&&(a=c[1])}(a!==this.currentPrefix||s.label.endsWith("-chapter")||s.label==="title"||!i)&&(this.currentPrefix=a,i=document.createElement("section"),i.className=`section section-${a}`,i.id=`section-${s.label}`,t.appendChild(i));const l=this.segmentFactory.create(s,o);this.elementCache.set(s.id,l),i.appendChild(l)}),this.sentinel&&this.sentinel.parentNode===this.container?this.container.insertBefore(t,this.sentinel):this.container.appendChild(t),this.renderedCount+=e.length,this.isRendering=!1,this.renderedCount>=this.items.length&&(this.sentinel&&this.sentinel.remove(),this.observer&&this.observer.disconnect())}_handlePlaySequence(e){if(!this.playSequenceCallback)return;const t=this.items[e],i=t.html?t.html.match(/^<h(\d)>/i):null;if(!i)return;const s=parseInt(i[1]),n=[];for(let o=e+1;o<this.items.length;o++){const a=this.items[o];if(a.label==="end")break;const r=a.html?a.html.match(/^<h(\d)>/i):null;if(r&&parseInt(r[1])<=s)break;a.audio&&a.audio!=="skip"&&n.push({id:a.id,audio:a.audio,text:a.text})}n.length>0?this.playSequenceCallback(n,t.id):alert("Không có dữ liệu âm thanh cho phần này.")}_handleKeyboardPlay(){if(!this.hoveredSegmentId)return;const e=this.items.find(t=>t.id===this.hoveredSegmentId);if(e)if(e.html&&e.html.match(/^<h[1-6]/i)){const t=this.items.indexOf(e);this._handlePlaySequence(t)}else e.audio&&e.audio!=="skip"&&this.playSegmentCallback&&this.playSegmentCallback(e.id,e.audio,e.text)}_handleKeyboardFlip(){if(!this.hoveredSegmentId)return;const e=this.items.find(i=>i.id===this.hoveredSegmentId);if(!e)return;const t=this.elementCache.get(this.hoveredSegmentId);if(t){const i=e.audio&&e.audio!=="skip",s=e.html&&e.html.match(/^<h[1-6]/i)&&e.label!=="title"&&e.label!=="subtitle";(i||s)&&this.maskManager.toggleMask(t,e)}}_ensureRendered(e){if(!(e===-1||e<this.renderedCount))for(;this.renderedCount<=e&&(this._renderNextBatch(),!(this.renderedCount>=this.items.length)););}scrollToSegment(e){this.highlightSegment(e,!0)}highlightSegment(e,t=!0){if(!this.container)return;let i=this.elementCache.get(e);if(!i){const s=this.items.findIndex(n=>n.id===e);s!==-1&&(this._ensureRendered(s),i=this.elementCache.get(e))}if(this.activeSegmentId!==null&&this.activeSegmentId!==e){const s=this.elementCache.get(this.activeSegmentId);s&&s.classList.remove("active")}i&&(i.classList.add("active"),this.activeSegmentId=e,t&&this._smartScroll(i))}_parseThreshold(e){return typeof e=="number"?e:typeof e!="string"?0:e.endsWith("vh")?parseFloat(e)/100*document.documentElement.clientHeight:parseFloat(e)||0}_smartScroll(e){if(!this.container||!e)return;const t=e.getBoundingClientRect(),i=this.container.getBoundingClientRect(),s=this._parseThreshold(k.SCROLL_THRESHOLD_TOP),n=this._parseThreshold(k.SCROLL_THRESHOLD_BOTTOM),o=i.top+s,a=i.bottom-n,r=t.top<o,l=t.bottom>a;if(r||l){const g=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)?"auto":k.SCROLL_BEHAVIOR,d=this.container.scrollTop+(t.top-o);this.container.scrollTo({top:d,behavior:g})}}clearHighlight(){if(this.activeSegmentId!==null){const e=this.elementCache.get(this.activeSegmentId);e&&e.classList.remove("active"),this.activeSegmentId=null}}updatePlaybackState(e,t,i,s){if(this.container.querySelectorAll(".play-btn:not(.play-sequence-btn)").forEach(a=>{a.classList.remove("active-play"),a.innerHTML='<i class="fas fa-circle"></i>',a.title="Nghe đoạn này"}),this.container.querySelectorAll(".play-sequence-btn").forEach(a=>{a.classList.remove("active-play"),a.innerHTML='<i class="fas fa-play-circle"></i>',a.title="Nghe toàn bộ phần này"}),!t||e==="stopped")return;const n=this.elementCache.get(t);if(!n)return;const o=n.querySelector(".play-btn:not(.play-sequence-btn)");if(o&&(o.classList.add("active-play"),o.innerHTML=e==="playing"?'<i class="fas fa-pause-circle"></i>':'<i class="fas fa-play-circle"></i>',o.title=e==="playing"?"Tạm dừng":"Tiếp tục"),i&&s){const a=this.elementCache.get(s);if(a){const r=a.querySelector(".play-sequence-btn");r&&(r.classList.add("active-play"),r.innerHTML=e==="playing"?'<i class="fas fa-pause-circle"></i>':'<i class="fas fa-play-circle"></i>',r.title=e==="playing"?"Tạm dừng":"Tiếp tục")}}}getFirstVisibleSegmentId(){if(!this.container)return null;const e=this.container.querySelectorAll(".segment");for(const t of e){const i=t.getBoundingClientRect();if(i.top+i.height>80&&i.top<window.innerHeight&&parseInt(t.dataset.id))return parseInt(t.dataset.id)}return null}}class W{constructor(e,t,i,s,n){this.playBtn=document.getElementById("play-all-btn"),this.pauseBtn=document.getElementById("pause-btn"),this.stopBtn=document.getElementById("stop-btn"),this.speedSelect=document.getElementById("speed-select"),this.loopBtn=document.getElementById("loop-btn"),this.hintToggleBtn=document.getElementById("hint-toggle-btn");const o="sutta_loop_enabled",a="tts_rate",r="sutta_hint_mode_enabled";if(this.playBtn&&this.playBtn.addEventListener("click",e),this.pauseBtn&&this.pauseBtn.addEventListener("click",t),this.stopBtn&&this.stopBtn.addEventListener("click",i),this.speedSelect){const l=localStorage.getItem(a);l&&(this.speedSelect.value=l),this.speedSelect.addEventListener("change",c=>{const g=parseFloat(c.target.value);localStorage.setItem(a,g),s(g)})}if(this.loopBtn&&(localStorage.getItem(o)==="true"&&this.loopBtn.classList.add("active"),this.loopBtn.addEventListener("click",()=>{const c=this.loopBtn.classList.toggle("active");localStorage.setItem(o,c),n&&n(c)})),this.hintToggleBtn){const l=localStorage.getItem(r);(l===null||l==="true")&&(this.hintToggleBtn.classList.add("active"),document.body.classList.add("hint-mode-active")),this.hintToggleBtn.addEventListener("click",()=>{const g=this.hintToggleBtn.classList.toggle("active");g?document.body.classList.add("hint-mode-active"):document.body.classList.remove("hint-mode-active"),localStorage.setItem(r,g)})}document.addEventListener("keydown",l=>{if(l.target.tagName==="INPUT"||l.target.tagName==="TEXTAREA"||l.target.isContentEditable)return;const c=l.key.toLowerCase();c==="g"&&this.loopBtn&&this.loopBtn.click(),c==="h"&&this.hintToggleBtn&&this.hintToggleBtn.click(),c==="t"&&this._changeSpeedIndex(1,s),c==="e"&&this._changeSpeedIndex(-1,s)})}_changeSpeedIndex(e,t){if(!this.speedSelect)return;const i=this.speedSelect.selectedIndex+e;if(i>=0&&i<this.speedSelect.options.length){this.speedSelect.selectedIndex=i;const s=parseFloat(this.speedSelect.value);localStorage.setItem("tts_rate",s),t&&t(s)}}updateState(e){if(!this.playBtn||!this.pauseBtn||!this.stopBtn)return;const t=this.pauseBtn.querySelector("i");switch(e){case"playing":this.playBtn.disabled=!0,this.pauseBtn.disabled=!1,this.stopBtn.disabled=!1,t&&(t.classList.remove("fa-play"),t.classList.add("fa-pause"));break;case"paused":this.playBtn.disabled=!0,this.pauseBtn.disabled=!1,this.stopBtn.disabled=!1,t&&(t.classList.remove("fa-pause"),t.classList.add("fa-play"));break;case"stopped":this.playBtn.disabled=!1,this.pauseBtn.disabled=!0,this.stopBtn.disabled=!0,t&&(t.classList.remove("fa-play"),t.classList.add("fa-pause"));break}}setSpeed(e){this.speedSelect&&(this.speedSelect.value=e.toString())}}class j{constructor(e){this.ttsEngine=e,this.modal=document.getElementById("settings-modal"),this.openBtn=document.getElementById("settings-btn"),this.closeBtn=document.querySelector(".close-modal"),this.form=document.getElementById("settings-form"),this.apiKeyInput=document.getElementById("api-key"),this.voiceSelect=document.getElementById("voice-select"),this.refreshVoicesBtn=document.getElementById("refresh-voices-btn"),this._setupListeners()}_setupListeners(){this.openBtn&&this.openBtn.addEventListener("click",e=>{e.preventDefault(),this._open()}),this.closeBtn&&this.closeBtn.addEventListener("click",e=>{e.preventDefault(),this._close()}),this.form&&this.form.addEventListener("submit",e=>{e.preventDefault(),this._save()}),this.refreshVoicesBtn&&this.refreshVoicesBtn.addEventListener("click",e=>{e.preventDefault(),this._loadVoices(!0)}),this.voiceSelect&&this.voiceSelect.addEventListener("change",e=>{this.ttsEngine.setVoice(e.target.value)}),window.addEventListener("click",e=>{e.target===this.modal&&this._close()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&!this.modal.classList.contains("hidden")&&this._close()})}_open(){try{this.modal.classList.remove("hidden"),this.ttsEngine&&(this.apiKeyInput&&(this.apiKeyInput.value=this.ttsEngine.getApiKey()||""),this._loadVoices(!1))}catch{}}_close(){this.modal.classList.add("hidden")}_save(){try{const e=this.apiKeyInput?this.apiKeyInput.value.trim():"";this.ttsEngine.setApiKey(e),this._close(),e?this._loadVoices(!0):this.voiceSelect&&(this.voiceSelect.innerHTML='<option value="" disabled selected>Vui lòng nhập API Key</option>')}catch{}}async _loadVoices(e){if(!this.ttsEngine||!this.ttsEngine.getApiKey()){this.voiceSelect&&(this.voiceSelect.innerHTML='<option value="" disabled selected>Vui lòng nhập API Key trước</option>');return}this.voiceSelect&&(this.voiceSelect.innerHTML='<option value="" disabled selected>Đang tải...</option>'),this.refreshVoicesBtn&&(this.refreshVoicesBtn.disabled=!0,this.refreshVoicesBtn.innerHTML='<i class="fas fa-spin fa-spinner"></i>');try{const t=await this.ttsEngine.getVoices(e);if(this.voiceSelect){this.voiceSelect.innerHTML="";const i=this.ttsEngine.currentVoice,s=i?i.name:"";!t||t.length===0?this.voiceSelect.innerHTML='<option value="" disabled selected>Không tìm thấy giọng tiếng Việt</option>':(t.forEach(n=>{const o=document.createElement("option");o.value=n.name,o.textContent=`${n.name} (${n.ssmlGender})`,n.name===s&&(o.selected=!0),this.voiceSelect.appendChild(o)}),t.length>0&&!t.find(n=>n.name===s)&&(this.voiceSelect.selectedIndex=0,this.ttsEngine.setVoice(t[0].name)))}}catch{this.voiceSelect&&(this.voiceSelect.innerHTML='<option value="" disabled selected>Lỗi tải giọng</option>')}finally{this.refreshVoicesBtn&&(this.refreshVoicesBtn.disabled=!1,this.refreshVoicesBtn.innerHTML='<i class="fas fa-sync-alt"></i>')}}}const Y={init(){const h=document.getElementById("btn-toggle-drawer"),e=document.getElementById("control-drawer");h&&e&&(h.addEventListener("click",t=>{t.stopPropagation(),e.classList.toggle("hidden"),h.classList.toggle("open");const i=document.getElementById("control-bar");i&&i.classList.toggle("expanded")}),document.addEventListener("click",t=>{if(!e.classList.contains("hidden")&&!e.contains(t.target)&&!h.contains(t.target)){e.classList.add("hidden"),h.classList.remove("open");const s=document.getElementById("control-bar");s&&s.classList.remove("expanded")}}),e.addEventListener("click",t=>{t.stopPropagation()}))}},I={HUE_COEFF:"35deg",SATURATE:"60%",STORAGE_KEY_PREFIX:"sutta_sepia_"},z={CONFIG:{STORAGE_KEY_THEME:"sutta_theme"},init(){const h=document.getElementById("btn-theme-toggle"),e=h?.querySelector(".icon-moon"),t=h?.querySelector(".icon-sun"),i=document.getElementById("sepia-control-panel"),s=document.getElementById("sepia-slider"),n=document.getElementById("btn-sepia-indicator");document.documentElement.style.setProperty("--sepia-hue-coeff",I.HUE_COEFF),document.documentElement.style.setProperty("--sepia-saturate",I.SATURATE);const o=window.matchMedia("(prefers-color-scheme: dark)").matches;let r=localStorage.getItem(this.CONFIG.STORAGE_KEY_THEME)||(o?"dark":"light");const l=u=>`${I.STORAGE_KEY_PREFIX}${u}`,c=()=>{if(!i)return;i.classList.contains("hidden")?(i.classList.remove("hidden"),n&&n.classList.add("panel-open")):(i.classList.add("hidden"),n&&n.classList.remove("panel-open"))},g=(u,m)=>{const y=m==="dark"?.2:.3;return u/100*y},d=(u,m)=>{const y=g(u,m);document.documentElement.style.setProperty("--sepia-overlay-opacity",y),s&&s.value!=u&&(s.value=u),n&&(n.textContent=`${u}%`)},p=u=>{document.documentElement.setAttribute("data-theme",u),localStorage.setItem(this.CONFIG.STORAGE_KEY_THEME,u),r=u,u==="dark"?(e?.classList.add("hidden"),t?.classList.remove("hidden")):(e?.classList.remove("hidden"),t?.classList.add("hidden"));const m=localStorage.getItem(l(u))||0;d(m,u)};p(r),n&&n.addEventListener("click",u=>{u.stopPropagation(),c()}),h&&h.addEventListener("click",()=>{p(r==="light"?"dark":"light"),i&&!i.classList.contains("hidden")&&c()}),s&&(s.addEventListener("input",u=>{const m=u.target.value;d(m,r),localStorage.setItem(l(r),m)}),document.addEventListener("click",u=>{i&&!i.classList.contains("hidden")&&!i.contains(u.target)&&!h.contains(u.target)&&(!n||!n.contains(u.target))&&c()}),i.addEventListener("click",u=>{u.stopPropagation()}))}},Q={MIN_SCALE:.8,MAX_SCALE:2,STEP:.1,DEFAULT_SCALE:1,STORAGE_KEY:"sutta_font_scale",init(){const h=document.getElementById("btn-font-decrease"),e=document.getElementById("btn-font-increase"),t=document.getElementById("font-size-label"),i=localStorage.getItem(this.STORAGE_KEY);let s=i?parseFloat(i):this.DEFAULT_SCALE;this.applyScale(s),h&&h.addEventListener("click",n=>{n.stopPropagation(),s>this.MIN_SCALE&&(s=Math.max(this.MIN_SCALE,s-this.STEP),this.applyScale(s))}),e&&e.addEventListener("click",n=>{n.stopPropagation(),s<this.MAX_SCALE&&(s=Math.min(this.MAX_SCALE,s+this.STEP),this.applyScale(s))}),t&&(t.addEventListener("click",n=>{n.stopPropagation(),s=this.DEFAULT_SCALE,this.applyScale(s)}),t.style.cursor="pointer")},applyScale(h){const e=Math.round(h*10)/10;document.documentElement.style.setProperty("--text-scale",e),localStorage.setItem(this.STORAGE_KEY,e)}},X="modulepreload",Z=function(h){return"/gioibon/"+h},T={},J=function(e,t,i){let s=Promise.resolve();if(t&&t.length>0){let r=function(l){return Promise.all(l.map(c=>Promise.resolve(c).then(g=>({status:"fulfilled",value:g}),g=>({status:"rejected",reason:g}))))};document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),a=o?.nonce||o?.getAttribute("nonce");s=r(t.map(l=>{if(l=Z(l),l in T)return;T[l]=!0;const c=l.endsWith(".css"),g=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${g}`))return;const d=document.createElement("link");if(d.rel=c?"stylesheet":X,c||(d.as="script"),d.crossOrigin="",d.href=l,a&&d.setAttribute("nonce",a),document.head.appendChild(d),c)return new Promise((p,u)=>{d.addEventListener("load",p),d.addEventListener("error",()=>u(new Error(`Unable to preload CSS for ${l}`)))})}))}function n(o){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=o,window.dispatchEvent(a),!a.defaultPrevented)throw o}return s.then(o=>{for(const a of o||[])a.status==="rejected"&&n(a.reason);return e().catch(n)})};function ee(h={}){const{immediate:e=!1,onNeedRefresh:t,onOfflineReady:i,onRegistered:s,onRegisteredSW:n,onRegisterError:o}=h;let a,r,l;const c=async(d=!0)=>{await r,l?.()};async function g(){if("serviceWorker"in navigator){if(a=await J(async()=>{const{Workbox:d}=await import("./vendor.BIl4cyR9.js");return{Workbox:d}},[]).then(({Workbox:d})=>new d("/gioibon/sw.js",{scope:"/gioibon/",type:"classic"})).catch(d=>{o?.(d)}),!a)return;l=()=>{a?.messageSkipWaiting()};{let d=!1;const p=()=>{d=!0,a?.addEventListener("controlling",u=>{u.isUpdate&&window.location.reload()}),t?.()};a.addEventListener("installed",u=>{typeof u.isUpdate>"u"?typeof u.isExternal<"u"&&u.isExternal?p():!d&&i?.():u.isUpdate||i?.()}),a.addEventListener("waiting",p)}a.register({immediate:e}).then(d=>{n?n("/gioibon/sw.js",d):s?.(d)}).catch(d=>{o?.(d)})}}return r=g(),c}function te(){const h=document.getElementById("btn-clear-cache");h&&h.addEventListener("click",async()=>{if(confirm("Bạn có chắc chắn muốn làm mới toàn bộ dữ liệu? Các cấu hình như API Key, font size và tốc độ đọc sẽ được giữ lại.")){h.disabled=!0,h.style.opacity="0.5";try{const n=["google_cloud_api_key","tts_voice_name","tts_rate","sutta_font_scale","sutta_theme","sutta_sepia_light","sutta_sepia_dark","sutta_loop_enabled","sutta_hint_mode_enabled"],o={};if(n.forEach(a=>{const r=localStorage.getItem(a);r!==null&&(o[a]=r)}),"serviceWorker"in navigator){const a=await navigator.serviceWorker.getRegistrations();for(let r of a)await r.unregister()}if("caches"in window){const a=await caches.keys();await Promise.all(a.map(r=>caches.delete(r)))}indexedDB.databases&&(await indexedDB.databases()).forEach(r=>{r.name&&indexedDB.deleteDatabase(r.name)}),localStorage.clear(),sessionStorage.clear(),Object.entries(o).forEach(([a,r])=>{localStorage.setItem(a,r)}),window.location.reload()}catch{alert("Đã xảy ra lỗi khi làm mới dữ liệu. Vui lòng thử lại."),h.disabled=!1,h.style.opacity="1"}}});const e=document.getElementById("pwa-toast"),t=document.getElementById("pwa-refresh"),i=document.getElementById("pwa-close"),s=document.getElementById("btn-update-app");if(e&&t&&i){const n=ee({onNeedRefresh(){e.classList.remove("hidden"),s&&s.classList.add("update-available")},onOfflineReady(){}}),o=()=>{n(!0)};t.addEventListener("click",o),s&&s.addEventListener("click",async()=>{if(!e.classList.contains("hidden")){o();return}s.classList.add("rotating"),s.title="Đang kiểm tra...";try{if("serviceWorker"in navigator){const a=await navigator.serviceWorker.getRegistration();a&&(await a.update(),setTimeout(()=>{s.classList.remove("rotating"),s.title="Kiểm tra & Cập nhật",e.classList.contains("hidden")&&alert("Ứng dụng và dữ liệu đã ở phiên bản mới nhất.")},1500))}}catch{s.classList.remove("rotating")}}),i.addEventListener("click",()=>{e.classList.add("hidden")})}}class P{constructor(e){this.contentLoader=e,this.isPrefetching=!1,this.cacheName="audio-mp3-cache"}async startPrefetch(){if(!this.isPrefetching){this.isPrefetching=!0;try{if(!("caches"in window))return;const e=await caches.open(this.cacheName),t=this.contentLoader.getAllSegments(),i=[...new Set(t.map(r=>r.audio).filter(r=>r&&r!=="skip"))],s=await e.keys();let n=0;for(const r of s){const c=new URL(r.url).pathname.split("/").pop();c&&c.endsWith(".mp3")&&!i.includes(c)&&(await e.delete(r),n++)}n>0;let o=0;const a=3;for(let r=0;r<i.length;r+=a){const l=i.slice(r,r+a);await Promise.all(l.map(async c=>{const g=`${v}app-content/audio/${c}`;if(!await e.match(g))try{await e.add(g),o++}catch{}})),await new Promise(c=>setTimeout(c,500))}o>0}catch{}finally{this.isPrefetching=!1}}}}document.addEventListener("DOMContentLoaded",async()=>{te(),await new Promise(a=>setTimeout(a,150));const h=new B,e=new V(h),t=new q(h),i=localStorage.getItem("sutta_loop_enabled")==="true";t.isLooping=i,Y.init(),z.init(),Q.init();const s=new G("content",(a,r,l)=>{t.playSegment(a,r,l)},(a,r)=>{t.playSequence(a,r)}),n=new K("toc-list","sidebar","sidebar-toggle",s),o=new W(()=>{if(t.isPaused)t.resume();else{const a=s.getFirstVisibleSegmentId();if(a){const r=e.getSegmentsStartingFrom(a);r.length>0&&t.playSequence(r)}else{const r=e.getAllSegments();r.length>0&&t.playSequence(r)}}},()=>{t.isPlaying?t.pause():t.isPaused&&t.resume()},()=>{t.stop()},a=>{t.setRate(a)},a=>{t.isLooping=a});o.setSpeed(t.currentRate),new j(t.engine),t.onSegmentStart=(a,r)=>{s.highlightSegment(a,r),s.updatePlaybackState(t.isPlaying?"playing":"paused",a,r,t.sequenceParentId)},t.onPlaybackEnd=()=>{s.clearHighlight(),o.updateState("stopped"),s.updatePlaybackState("stopped",null,!1,null)},t.onPlaybackStateChange=a=>{o.updateState(a),s.updatePlaybackState(a,t.currentSegmentId,t.isSequence,t.sequenceParentId)};try{const a=await e.load();s.render(a),n.render(a);const r=document.querySelector(".loading");r&&r.remove(),"requestIdleCallback"in window?requestIdleCallback(()=>{new P(e).startPrefetch()}):setTimeout(()=>{new P(e).startPrefetch()},3e3)}catch{document.getElementById("content").innerHTML='<div class="error">Không thể tải dữ liệu. Vui lòng thử lại sau.</div>'}});
